<!doctype html><html lang=en data-bs-theme=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=preload href=https://backslashphp.github.io/fonts/vendor/jost/jost-v4-latin-regular.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=https://backslashphp.github.io/fonts/vendor/jost/jost-v4-latin-500.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=https://backslashphp.github.io/fonts/vendor/jost/jost-v4-latin-700.woff2 as=font type=font/woff2 crossorigin><script src=/js/color-mode.86a91f050a481d0a3f0c72ac26543cb6228c770875981c58dcbc008fd3f875c8.js integrity="sha256-hqkfBQpIHQo/DHKsJlQ8tiKMdwh1mBxY3LwAj9P4dcg="></script><link rel=stylesheet href="/main.848cf89bbba15d326e466c3c5eeec709580aa4541c43c077e8fc1facf7bbc5cb986937262c2313a994606d42393d535d1ed8e23ec6e3f0784e69c801ec89289a.css" integrity="sha512-hIz4m7uhXTJuRmw8Xu7HCVgKpFQcQ8B36PwfrPe7xcuYaTcmLCMTqZRgbUI5PVNdHtjiPsbj8HhOacgB7Ikomg==" crossorigin=anonymous><noscript><style>img.lazyload{display:none}</style></noscript><base href=https://backslashphp.github.io/docs/testing/writing-test-scenarios/><link rel=canonical href=https://backslashphp.github.io/docs/testing/writing-test-scenarios/><title>Writing Test Scenarios | Backslash PHP</title><meta name=description content="CQRS & Event Sourcing for PHP"><link rel=icon href=/favicon.ico sizes=32x32><link rel=icon href=/favicon.svg type=image/svg+xml><link rel=apple-touch-icon href=/apple-touch-icon.png sizes=180x180 type=image/png><link rel=icon href=/favicon-192x192.png sizes=192x192 type=image/png><link rel=icon href=/favicon-512x512.png sizes=512x512 type=image/png><link rel=manifest href=/manifest.webmanifest><meta property="og:url" content="https://backslashphp.github.io/docs/testing/writing-test-scenarios/"><meta property="og:site_name" content="Backslash PHP"><meta property="og:title" content="Writing Test Scenarios"><meta property="og:description" content="The Scenario component provides a fluent, behavior-driven interface for testing event-sourced applications. It uses the Play class to define test scenarios in a readable, expressive Given-When-Then manner."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="docs"><meta property="og:image" content="https://backslashphp.github.io/cover.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://backslashphp.github.io/cover.png"><meta name=twitter:title content="Writing Test Scenarios"><meta name=twitter:description content="The Scenario component provides a fluent, behavior-driven interface for testing event-sourced applications. It uses the Play class to define test scenarios in a readable, expressive Given-When-Then manner."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","item":"https://backslashphp.github.io/","name":"Cqrs \u0026 Event Sourcing for Php","position":1},{"@type":"ListItem","item":"https://backslashphp.github.io/docs/","name":"Documentation","position":2},{"@type":"ListItem","item":"https://backslashphp.github.io/docs/testing/","name":"Testing Your Application","position":3},{"@type":"ListItem","name":"Writing Test Scenarios","position":4}]}</script></head><body class="single section docs" data-bs-spy=scroll data-bs-target=#toc data-bs-root-margin="0px 0px -60%" data-bs-smooth-scroll=true tabindex=0><div class=sticky-top><div class=header-bar></div><header class="navbar navbar-expand-lg"><div class=container-lg><a class="navbar-brand me-auto me-lg-3" href=/>Backslash PHP</a>
<button type=button id=searchToggleMobile class="btn btn-link nav-link mx-2 d-lg-none" aria-label="Search website">
<svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
</button>
<button class="btn btn-link d-lg-none" type=button data-bs-toggle=offcanvas data-bs-target=#offcanvasNavSection aria-controls=offcanvasNavSection aria-label="Open section navigation menu">
<svg class="icon icon-tabler icon-tabler-dots-vertical" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 12m-1 0a1 1 0 102 0 1 1 0 10-2 0"/><path d="M12 19m-1 0a1 1 0 102 0 1 1 0 10-2 0"/><path d="M12 5m-1 0a1 1 0 102 0 1 1 0 10-2 0"/></svg></button><div class="offcanvas offcanvas-start d-lg-none" tabindex=-1 id=offcanvasNavSection aria-labelledby=offcanvasNavSectionLabel><div class=header-bar></div><div class=offcanvas-header><h5 class=offcanvas-title id=offcanvasNavSectionLabel>Docs</h5><button type=button class="btn btn-link nav-link p-0 ms-auto" data-bs-dismiss=offcanvas aria-label=Close>
<svg class="icon icon-tabler icon-tabler-x" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M18 6 6 18"/><path d="M6 6l12 12"/></svg></button></div><div class=offcanvas-body><aside class="doks-sidebar mt-n3"><nav id=doks-docs-nav aria-label="Tertiary navigation"><nav class="section-nav docs-links"><ul class=list-unstyled><li><details open><summary>Getting Started</summary><ul class="list-unstyled list-nested"><li><a href=/docs/getting-started/introduction/>Introduction</a></li><li><a href=/docs/getting-started/architecture-overview/>Architecture Overview</a></li><li><a href=/docs/getting-started/quick-start-guide/>Quick Start Guide</a></li></ul></details></li><li><details open><summary>Event Sourcing</summary><ul class="list-unstyled list-nested"><li><a href=/docs/event-sourcing/understanding-event-sourcing/>Understanding Event Sourcing</a></li><li><a href=/docs/event-sourcing/defining-events/>Defining Events</a></li><li><a href=/docs/event-sourcing/querying-events/>Querying Events</a></li><li><a href=/docs/event-sourcing/building-models/>Building Models</a></li></ul></details></li><li><details open><summary>Commands and Projections (CQRS)</summary><ul class="list-unstyled list-nested"><li><a href=/docs/cqrs/understanding-cqrs/>Understanding CQRS</a></li><li><a href=/docs/cqrs/dispatching-commands/>Dispatching Commands</a></li><li><a href=/docs/cqrs/reacting-with-event-handlers/>Reacting with Event Handlers</a></li><li><a href=/docs/cqrs/building-projections/>Building Projections</a></li></ul></details></li><li><details open open><summary>Testing Your Application</summary><ul class="list-unstyled list-nested"><li><a href=/docs/testing/setting-up-tests/>Setting Up Tests</a></li><li class=active><a aria-current=page href=/docs/testing/writing-test-scenarios/>Writing Test Scenarios</a></li></ul></details></li><li><details open><summary>Customization</summary><ul class="list-unstyled list-nested"><li><a href=/docs/customization/extending-with-middleware/>Extending with Middleware</a></li><li><a href=/docs/customization/enriching-event-streams/>Enriching Event Streams</a></li></ul></details></li><li><details open><summary>Application Setup</summary><ul class="list-unstyled list-nested"><li><a href=/docs/application-setup/defining-services/>Defining Services</a></li><li><a href=/docs/application-setup/registering-handlers/>Registering Handlers</a></li><li><a href=/docs/application-setup/using-the-bootstrap-file/>Using the Bootstrap File</a></li></ul></details></li><li><details open><summary>Maintenance</summary><ul class="list-unstyled list-nested"><li><a href=/docs/maintenance/rebuilding-projections/>Rebuilding Projections</a></li></ul></details></li></ul></nav></nav></aside></div></div><button class="btn btn-link nav-link mx-2 order-3 d-lg-none" type=button data-bs-toggle=offcanvas data-bs-target=#offcanvasNavMain aria-controls=offcanvasNavMain aria-label="Open main navigation menu">
<svg class="icon icon-tabler icon-tabler-menu" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><line x1="4" y1="8" x2="20" y2="8"/><line x1="4" y1="16" x2="20" y2="16"/></svg></button><div class="offcanvas offcanvas-end h-auto" tabindex=-1 id=offcanvasNavMain aria-labelledby=offcanvasNavMainLabel><div class="header-bar d-lg-none"></div><div class=offcanvas-header><h5 class=offcanvas-title id=offcanvasNavMainLabel>Backslash PHP</h5><button type=button class="btn btn-link nav-link p-0 ms-auto" data-bs-dismiss=offcanvas aria-label=Close>
<svg class="icon icon-tabler icon-tabler-x" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M18 6 6 18"/><path d="M6 6l12 12"/></svg></button></div><div class="offcanvas-body d-flex flex-column flex-lg-row justify-content-between"><ul class="navbar-nav flex-grow-1"><li class=nav-item><a class=nav-link href=https://backslashphp.github.io/docs/getting-started/introduction/>Documentation</a></li><li class=nav-item><a class=nav-link href=https://github.com/backslashphp/demo>Demo</a></li></ul><button type=button id=searchToggleDesktop class="btn btn-link nav-link p-2 d-none d-lg-block" aria-label="Search website">
<svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
</button>
<button id=buttonColorMode class="btn btn-link mx-auto nav-link p-0 ms-lg-2 me-lg-1" type=button aria-label="Toggle theme">
<svg data-bs-theme-value="dark" class="icon icon-tabler icon-tabler-moon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 3c.132.0.263.0.393.0a7.5 7.5.0 007.92 12.446A9 9 0 1112 2.992z"/></svg>
<svg data-bs-theme-value="light" class="icon icon-tabler icon-tabler-sun" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 12m-4 0a4 4 0 108 0 4 4 0 10-8 0m-5 0h1m8-9v1m8 8h1m-9 8v1M5.6 5.6l.7.7m12.1-.7-.7.7m0 11.4.7.7m-12.1-.7-.7.7"/></svg></button><ul id=socialMenu class="nav mx-auto flex-row order-lg-4"><li class=nav-item><a class="nav-link social-link" href=https://github.com/backslashphp/backslash><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg><small class="ms-2 visually-hidden">GitHub</small></a></li></ul></div></div></div></header></div><div class=modal id=searchModal tabindex=-1 aria-labelledby=searchModalLabel aria-hidden=true><div class="modal-dialog modal-dialog-scrollable modal-fullscreen-md-down"><div class=modal-content><div class=modal-header><h1 class="modal-title fs-5 visually-hidden" id=searchModalLabel>Search</h1><button type=button class="btn-close visually-hidden" data-bs-dismiss=modal aria-label=Close></button><div class="search-input flex-grow-1 d-none"><form id=search-form class=search-form action=# method=post accept-charset=UTF-8 role=search><label for=query class=visually-hidden>Search</label><div class=d-flex><input type=search id=query name=query class="search-text form-control form-control-lg" placeholder=Search aria-label=Search maxlength=128 autocomplete=off>
<button type=button class="btn btn-link text-decoration-none px-0 ms-3 d-md-none" data-bs-dismiss=modal aria-label=Close>Cancel</button></div></form></div></div><div class=modal-body><p class="search-loading status message d-none mt-3 text-center">Loading search indexâ€¦</p><p class="search-no-recent message d-none mt-3 text-center">No recent searches</p><p class="search-no-results message d-none mt-3 text-center">No results for "<strong><span class=query-no-results>Query here</span></strong>"</p><div id=searchResults class=search-results></div><template><article class="search-result list-view"><div class="card my-3"><div class=card-body><header><h2 class="h5 title title-submitted mb-0"><a class="stretched-link text-decoration-none text-reset" href=#>Title here</a></h2><div class="submitted d-none"><time class=created-date>Date here</time></div></header><div class=content>Summary here</div></div></div></article></template></div><div class=modal-footer><ul class="list-inline me-auto d-none d-md-block"><li class=list-inline-item><kbd class=me-2><svg width="15" height="15" aria-label="Enter key" role="img"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.2"><path d="M12 3.53088v3c0 1-1 2-2 2H4m3 3-3-3 3-3"/></g></svg></kbd><span class=DocSearch-Label>to select</span></li><li class=list-inline-item><kbd class=me-2><svg width="15" height="15" aria-label="Arrow down" role="img"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.2"><path d="M7.5 3.5v8m3-3-3 3-3-3"/></g></svg></kbd><kbd class=me-2><svg width="15" height="15" aria-label="Arrow up" role="img"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.2"><path d="M7.5 11.5v-8m3 3-3-3-3 3"/></g></svg></kbd><span class=DocSearch-Label>to navigate</span></li><li class=list-inline-item><kbd class=me-2><svg width="15" height="15" aria-label="Escape key" role="img"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.2"><path d="M13.6167 8.936c-.1065.3583-.6883.962-1.4875.962-.7993.0-1.653-.9165-1.653-2.1258v-.5678c0-1.2548.7896-2.1016 1.653-2.1016s1.3601.4778 1.4875 1.0724M9 6c-.1352-.4735-.7506-.9219-1.46-.8972-.7092.0246-1.344.57-1.344 1.2166s.4198.8812 1.3445.9805C8.465 7.3992 8.968 7.9337 9 8.5s-.454 1.398-1.4595 1.398C6.6593 9.898 6 9 5.963 8.4851m-1.4748.5368c-.2635.5941-.8099.876-1.5443.876s-1.7073-.6248-1.7073-2.204v-.4603c0-1.0416.721-2.131 1.7073-2.131.9864.0 1.6425 1.031 1.5443 2.2492h-2.956"/></g></svg></kbd><span class=DocSearch-Label>to close</span></li></ul><p class=d-md-none>Search by <a class=text-decoration-none href=https://github.com/nextapps-de/flexsearch>FlexSearch</a></p></div></div></div></div><div class="wrap container-lg" role=document><div class=content><div class="row flex-xl-nowrap"><div class="col-lg-5 col-xl-4 docs-sidebar docs-sidebar-offset d-none d-lg-block"><nav class="section-nav docs-links"><ul class=list-unstyled><li><details open><summary>Getting Started</summary><ul class="list-unstyled list-nested"><li><a href=/docs/getting-started/introduction/>Introduction</a></li><li><a href=/docs/getting-started/architecture-overview/>Architecture Overview</a></li><li><a href=/docs/getting-started/quick-start-guide/>Quick Start Guide</a></li></ul></details></li><li><details open><summary>Event Sourcing</summary><ul class="list-unstyled list-nested"><li><a href=/docs/event-sourcing/understanding-event-sourcing/>Understanding Event Sourcing</a></li><li><a href=/docs/event-sourcing/defining-events/>Defining Events</a></li><li><a href=/docs/event-sourcing/querying-events/>Querying Events</a></li><li><a href=/docs/event-sourcing/building-models/>Building Models</a></li></ul></details></li><li><details open><summary>Commands and Projections (CQRS)</summary><ul class="list-unstyled list-nested"><li><a href=/docs/cqrs/understanding-cqrs/>Understanding CQRS</a></li><li><a href=/docs/cqrs/dispatching-commands/>Dispatching Commands</a></li><li><a href=/docs/cqrs/reacting-with-event-handlers/>Reacting with Event Handlers</a></li><li><a href=/docs/cqrs/building-projections/>Building Projections</a></li></ul></details></li><li><details open open><summary>Testing Your Application</summary><ul class="list-unstyled list-nested"><li><a href=/docs/testing/setting-up-tests/>Setting Up Tests</a></li><li class=active><a aria-current=page href=/docs/testing/writing-test-scenarios/>Writing Test Scenarios</a></li></ul></details></li><li><details open><summary>Customization</summary><ul class="list-unstyled list-nested"><li><a href=/docs/customization/extending-with-middleware/>Extending with Middleware</a></li><li><a href=/docs/customization/enriching-event-streams/>Enriching Event Streams</a></li></ul></details></li><li><details open><summary>Application Setup</summary><ul class="list-unstyled list-nested"><li><a href=/docs/application-setup/defining-services/>Defining Services</a></li><li><a href=/docs/application-setup/registering-handlers/>Registering Handlers</a></li><li><a href=/docs/application-setup/using-the-bootstrap-file/>Using the Bootstrap File</a></li></ul></details></li><li><details open><summary>Maintenance</summary><ul class="list-unstyled list-nested"><li><a href=/docs/maintenance/rebuilding-projections/>Rebuilding Projections</a></li></ul></details></li></ul></nav></div><nav class="docs-toc docs-toc-offset d-none d-xl-block col-xl-3" aria-label="Secondary navigation"><div class=page-links><h3>On this page</h3><nav id=toc><ul><li><a href=#understanding-scenarios>Understanding scenarios</a></li><li><a href=#writing-basic-scenarios-with-play>Writing basic scenarios with Play</a></li><li><a href=#setting-up-initial-state-with-given>Setting up initial state with given()</a><ul><li><a href=#given-with-commands>Given with commands</a></li><li><a href=#given-with-events>Given with events</a></li></ul></li><li><a href=#executing-actions-with-when>Executing actions with when()</a><ul><li><a href=#when-with-commands>When with commands</a></li><li><a href=#when-with-closures>When with closures</a></li></ul></li><li><a href=#writing-assertions-with-then>Writing assertions with then()</a><ul><li><a href=#asserting-on-published-events>Asserting on published events</a></li><li><a href=#asserting-on-updated-projections>Asserting on updated projections</a></li><li><a href=#custom-assertions-with-repository>Custom assertions with repository</a></li><li><a href=#custom-assertions-without-parameters>Custom assertions without parameters</a></li></ul></li><li><a href=#testing-business-rule-violations>Testing business rule violations</a></li><li><a href=#chaining-multiple-plays>Chaining multiple plays</a></li><li><a href=#complete-scenario-example>Complete scenario example</a></li><li><a href=#optimizing-test-performance-with-event-publishing-modes>Optimizing test performance with event publishing modes</a><ul><li><a href=#automatic-projection-detection-detect-mode>Automatic projection detection (DETECT mode)</a></li><li><a href=#changing-modes-for-specific-tests>Changing modes for specific tests</a></li><li><a href=#available-modes>Available modes</a></li></ul></li><li><a href=#using-assertionstrait>Using AssertionsTrait</a></li><li><a href=#chaining-play-methods>Chaining Play methods</a></li><li><a href=#testing-models-in-isolation>Testing models in isolation</a></li><li><a href=#best-practices>Best practices</a></li></ul></nav></div></nav><main class="docs-content col-lg-11 col-xl-9 mx-xl-auto"><h1>Writing Test Scenarios</h1><nav class="toc-mobile d-xl-none" aria-label="Quaternary navigation"><details><summary>On this page</summary><div class=page-links><nav id=TableOfContents><ul><li><a href=#understanding-scenarios>Understanding scenarios</a></li><li><a href=#writing-basic-scenarios-with-play>Writing basic scenarios with Play</a></li><li><a href=#setting-up-initial-state-with-given>Setting up initial state with given()</a><ul><li><a href=#given-with-commands>Given with commands</a></li><li><a href=#given-with-events>Given with events</a></li></ul></li><li><a href=#executing-actions-with-when>Executing actions with when()</a><ul><li><a href=#when-with-commands>When with commands</a></li><li><a href=#when-with-closures>When with closures</a></li></ul></li><li><a href=#writing-assertions-with-then>Writing assertions with then()</a><ul><li><a href=#asserting-on-published-events>Asserting on published events</a></li><li><a href=#asserting-on-updated-projections>Asserting on updated projections</a></li><li><a href=#custom-assertions-with-repository>Custom assertions with repository</a></li><li><a href=#custom-assertions-without-parameters>Custom assertions without parameters</a></li></ul></li><li><a href=#testing-business-rule-violations>Testing business rule violations</a></li><li><a href=#chaining-multiple-plays>Chaining multiple plays</a></li><li><a href=#complete-scenario-example>Complete scenario example</a></li><li><a href=#optimizing-test-performance-with-event-publishing-modes>Optimizing test performance with event publishing modes</a><ul><li><a href=#automatic-projection-detection-detect-mode>Automatic projection detection (DETECT mode)</a></li><li><a href=#changing-modes-for-specific-tests>Changing modes for specific tests</a></li><li><a href=#available-modes>Available modes</a></li></ul></li><li><a href=#using-assertionstrait>Using AssertionsTrait</a></li><li><a href=#chaining-play-methods>Chaining Play methods</a></li><li><a href=#testing-models-in-isolation>Testing models in isolation</a></li><li><a href=#best-practices>Best practices</a></li></ul></nav></div></details></nav><p>The <code>Scenario</code> component provides a fluent, behavior-driven interface for testing event-sourced applications. It uses
the <code>Play</code> class to define test scenarios in a readable, expressive Given-When-Then manner.</p><h2 id=understanding-scenarios>Understanding scenarios<a href=#understanding-scenarios class=anchor aria-hidden=true>#</a></h2><p>Scenarios test the complete flow from command dispatch through event publication to projection updates. They verify that
commands produce the expected events and that projections are updated correctly.</p><p>The <code>Scenario</code> class was instantiated in your base test case (section 12). Each test creates <code>Play</code> instances and
executes them via <code>scenario->play()</code>.</p><p>A scenario can execute multiple plays sequentially, similar to acts in a theater piece. Each play represents a distinct
phase of the test, and subsequent plays see the effects of previous plays.</p><h2 id=writing-basic-scenarios-with-play>Writing basic scenarios with Play<a href=#writing-basic-scenarios-with-play class=anchor aria-hidden=true>#</a></h2><p>Create test scenarios using the <code>Play</code> class with the Given-When-Then pattern. A Play defines:</p><ul><li><strong>Initial state (Given)</strong> via <code>given()</code> - accepts events or commands</li><li><strong>Actions (When)</strong> via <code>when()</code> - accepts commands or closures</li><li><strong>Assertions (Then)</strong> via <code>then()</code> - automatic parameter routing based on type hints</li><li><strong>Expected exceptions</strong> via <code>thenExpectException()</code> or <code>thenExpectExceptionMessage()</code></li></ul><p>The order of these methods matters: setup methods should come first, followed by actions, then assertions.</p><p>Here&rsquo;s a basic example:</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=c1>#[Test]
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>public</span> <span class=k>function</span> <span class=nf>it_publishes_event_when_registering_student</span><span class=p>()</span><span class=o>:</span> <span class=nx>void</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>scenario</span><span class=o>-&gt;</span><span class=na>play</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=k>new</span> <span class=nx>Play</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=o>-&gt;</span><span class=na>when</span><span class=p>(</span><span class=k>new</span> <span class=nx>RegisterStudentCommand</span><span class=p>(</span><span class=s1>&#39;1&#39;</span><span class=p>,</span> <span class=s1>&#39;John&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=o>-&gt;</span><span class=na>then</span><span class=p>(</span><span class=nx>fn</span> <span class=p>(</span><span class=nx>PublishedEvents</span> <span class=nv>$events</span><span class=p>)</span> <span class=o>=&gt;</span>
</span></span><span class=line><span class=cl>                <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>assertPublishedEventsContainExactly</span><span class=p>([</span>
</span></span><span class=line><span class=cl>                    <span class=nx>StudentRegisteredEvent</span><span class=o>::</span><span class=na>class</span> <span class=o>=&gt;</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=p>],</span> <span class=nv>$events</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></figure></div><h2 id=setting-up-initial-state-with-given>Setting up initial state with given()<a href=#setting-up-initial-state-with-given class=anchor aria-hidden=true>#</a></h2><p>Use <code>given()</code> to establish the initial state before executing your test action. The <code>given()</code> method accepts both events
and commands, making it flexible for different testing scenarios.</p><h3 id=given-with-commands>Given with commands<a href=#given-with-commands class=anchor aria-hidden=true>#</a></h3><p>Commands passed to <code>given()</code> are dispatched before the main test action, setting up the required initial state:</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>scenario</span><span class=o>-&gt;</span><span class=na>play</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=k>new</span> <span class=nx>Play</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=o>-&gt;</span><span class=na>given</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=k>new</span> <span class=nx>DefineCourseCommand</span><span class=p>(</span><span class=s1>&#39;123&#39;</span><span class=p>,</span> <span class=s1>&#39;PHP Basics&#39;</span><span class=p>,</span> <span class=mi>10</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=k>new</span> <span class=nx>RegisterStudentCommand</span><span class=p>(</span><span class=s1>&#39;1&#39;</span><span class=p>,</span> <span class=s1>&#39;Alice&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=o>-&gt;</span><span class=na>when</span><span class=p>(</span><span class=k>new</span> <span class=nx>SubscribeStudentToCourseCommand</span><span class=p>(</span><span class=s1>&#39;1&#39;</span><span class=p>,</span> <span class=s1>&#39;123&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=o>-&gt;</span><span class=na>then</span><span class=p>(</span><span class=nx>fn</span> <span class=p>(</span><span class=nx>PublishedEvents</span> <span class=nv>$events</span><span class=p>)</span> <span class=o>=&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>assertPublishedEventsContain</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=nx>StudentSubscribedToCourseEvent</span><span class=o>::</span><span class=na>class</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nv>$events</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>);</span></span></span></code></pre></div></figure></div><h3 id=given-with-events>Given with events<a href=#given-with-events class=anchor aria-hidden=true>#</a></h3><p>You can also use <code>given()</code> to directly set up state with events, which is useful when you want to bypass command
validation or set up specific event sequences:</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>scenario</span><span class=o>-&gt;</span><span class=na>play</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=k>new</span> <span class=nx>Play</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=o>-&gt;</span><span class=na>given</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=k>new</span> <span class=nx>CourseDefinedEvent</span><span class=p>(</span><span class=s1>&#39;123&#39;</span><span class=p>,</span> <span class=s1>&#39;PHP Basics&#39;</span><span class=p>,</span> <span class=mi>10</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=o>-&gt;</span><span class=na>when</span><span class=p>(</span><span class=k>new</span> <span class=nx>ChangeCourseCapacityCommand</span><span class=p>(</span><span class=s1>&#39;123&#39;</span><span class=p>,</span> <span class=mi>20</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=o>-&gt;</span><span class=na>then</span><span class=p>(</span><span class=nx>fn</span> <span class=p>(</span><span class=nx>PublishedEvents</span> <span class=nv>$events</span><span class=p>)</span> <span class=o>=&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>assertPublishedEventsContain</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=nx>CourseCapacityChangedEvent</span><span class=o>::</span><span class=na>class</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nv>$events</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>);</span></span></span></code></pre></div></figure></div><p>The <code>given()</code> method automatically wraps raw events in <code>RecordedEvent</code> instances with appropriate metadata.</p><h2 id=executing-actions-with-when>Executing actions with when()<a href=#executing-actions-with-when class=anchor aria-hidden=true>#</a></h2><p>The <code>when()</code> method is the heart of your test - it defines what action you&rsquo;re testing. It accepts both commands and
closures, giving you flexibility in how you trigger the behavior under test.</p><h3 id=when-with-commands>When with commands<a href=#when-with-commands class=anchor aria-hidden=true>#</a></h3><p>Pass commands to <code>when()</code> to execute them through the normal command handling flow:</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>scenario</span><span class=o>-&gt;</span><span class=na>play</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=k>new</span> <span class=nx>Play</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=o>-&gt;</span><span class=na>when</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=k>new</span> <span class=nx>RegisterStudentCommand</span><span class=p>(</span><span class=s1>&#39;1&#39;</span><span class=p>,</span> <span class=s1>&#39;John&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=k>new</span> <span class=nx>RegisterStudentCommand</span><span class=p>(</span><span class=s1>&#39;2&#39;</span><span class=p>,</span> <span class=s1>&#39;Alice&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=o>-&gt;</span><span class=na>then</span><span class=p>(</span><span class=nx>fn</span> <span class=p>(</span><span class=nx>PublishedEvents</span> <span class=nv>$events</span><span class=p>)</span> <span class=o>=&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>assertPublishedEventsCount</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=nv>$events</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>);</span></span></span></code></pre></div></figure></div><h3 id=when-with-closures>When with closures<a href=#when-with-closures class=anchor aria-hidden=true>#</a></h3><p>Use closures with <code>when()</code> to execute custom logic during the test. The closure can receive a <code>RepositoryInterface</code>
parameter for direct model manipulation:</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>scenario</span><span class=o>-&gt;</span><span class=na>play</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=k>new</span> <span class=nx>Play</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=o>-&gt;</span><span class=na>given</span><span class=p>(</span><span class=k>new</span> <span class=nx>StudentRegisteredEvent</span><span class=p>(</span><span class=s1>&#39;1&#39;</span><span class=p>,</span> <span class=s1>&#39;John&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=o>-&gt;</span><span class=na>when</span><span class=p>(</span><span class=k>function</span> <span class=p>(</span><span class=nx>RepositoryInterface</span> <span class=nv>$repo</span><span class=p>)</span><span class=o>:</span> <span class=nx>void</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nv>$model</span> <span class=o>=</span> <span class=nv>$repo</span><span class=o>-&gt;</span><span class=na>loadModel</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=nx>Student</span><span class=o>::</span><span class=na>class</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nx>Identifier</span><span class=o>::</span><span class=na>is</span><span class=p>(</span><span class=s1>&#39;studentId&#39;</span><span class=p>,</span> <span class=s1>&#39;1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nv>$model</span><span class=o>-&gt;</span><span class=na>changeName</span><span class=p>(</span><span class=s1>&#39;Jane&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nv>$repo</span><span class=o>-&gt;</span><span class=na>storeChanges</span><span class=p>(</span><span class=nv>$model</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>})</span>
</span></span><span class=line><span class=cl>        <span class=o>-&gt;</span><span class=na>then</span><span class=p>(</span><span class=nx>fn</span> <span class=p>(</span><span class=nx>PublishedEvents</span> <span class=nv>$events</span><span class=p>)</span> <span class=o>=&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>assertNotEmpty</span><span class=p>(</span><span class=nv>$events</span><span class=o>-&gt;</span><span class=na>getAllOf</span><span class=p>(</span><span class=nx>StudentNameChangedEvent</span><span class=o>::</span><span class=na>class</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>);</span></span></span></code></pre></div></figure></div><p>Closures can also be used for other purposes like defining constants or setting up test data:</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>scenario</span><span class=o>-&gt;</span><span class=na>play</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=k>new</span> <span class=nx>Play</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=o>-&gt;</span><span class=na>given</span><span class=p>(</span><span class=k>new</span> <span class=nx>DefineCourseCommand</span><span class=p>(</span><span class=s1>&#39;123&#39;</span><span class=p>,</span> <span class=s1>&#39;PHP Basics&#39;</span><span class=p>,</span> <span class=mi>10</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=o>-&gt;</span><span class=na>when</span><span class=p>(</span><span class=k>function</span> <span class=p>()</span><span class=o>:</span> <span class=nx>void</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>define</span><span class=p>(</span><span class=s1>&#39;MY_CONSTANT&#39;</span><span class=p>,</span> <span class=s1>&#39;some-value&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>})</span>
</span></span><span class=line><span class=cl>        <span class=o>-&gt;</span><span class=na>when</span><span class=p>(</span><span class=k>new</span> <span class=nx>ChangeCourseCapacityCommand</span><span class=p>(</span><span class=s1>&#39;123&#39;</span><span class=p>,</span> <span class=mi>20</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=o>-&gt;</span><span class=na>then</span><span class=p>(</span><span class=nx>fn</span> <span class=p>()</span> <span class=o>=&gt;</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>assertTrue</span><span class=p>(</span><span class=nx>defined</span><span class=p>(</span><span class=s1>&#39;MY_CONSTANT&#39;</span><span class=p>)))</span>
</span></span><span class=line><span class=cl><span class=p>);</span></span></span></code></pre></div></figure></div><p>Multiple <code>when()</code> calls execute in the order they&rsquo;re defined.</p><h2 id=writing-assertions-with-then>Writing assertions with then()<a href=#writing-assertions-with-then class=anchor aria-hidden=true>#</a></h2><p>The <code>then()</code> method is where you verify the results of your test. It supports automatic parameter routing based on type
hints, allowing you to assert on events, projections, or use the repository directly.</p><h3 id=asserting-on-published-events>Asserting on published events<a href=#asserting-on-published-events class=anchor aria-hidden=true>#</a></h3><p>Use <code>then()</code> with a <code>PublishedEvents</code> parameter to verify which events were published:</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>scenario</span><span class=o>-&gt;</span><span class=na>play</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=k>new</span> <span class=nx>Play</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=o>-&gt;</span><span class=na>when</span><span class=p>(</span><span class=k>new</span> <span class=nx>RegisterStudentCommand</span><span class=p>(</span><span class=s1>&#39;1&#39;</span><span class=p>,</span> <span class=s1>&#39;John&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=o>-&gt;</span><span class=na>then</span><span class=p>(</span><span class=nx>fn</span> <span class=p>(</span><span class=nx>PublishedEvents</span> <span class=nv>$events</span><span class=p>)</span> <span class=o>=&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>assertPublishedEventsContainExactly</span><span class=p>([</span>
</span></span><span class=line><span class=cl>                <span class=nx>StudentRegisteredEvent</span><span class=o>::</span><span class=na>class</span> <span class=o>=&gt;</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>],</span> <span class=nv>$events</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=o>-&gt;</span><span class=na>then</span><span class=p>(</span><span class=k>function</span> <span class=p>(</span><span class=nx>PublishedEvents</span> <span class=nv>$events</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// You can also use a full closure for more complex assertions
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>assertPublishedEventsContain</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=nx>StudentRegisteredEvent</span><span class=o>::</span><span class=na>class</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nv>$events</span>
</span></span><span class=line><span class=cl>            <span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>assertPublishedEventsCount</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=nv>$events</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>);</span></span></span></code></pre></div></figure></div><p>The <code>PublishedEvents</code> parameter contains all events published <strong>during the when() phase only</strong>. Events from the given()
phase are not included in this collection.</p><h3 id=asserting-on-updated-projections>Asserting on updated projections<a href=#asserting-on-updated-projections class=anchor aria-hidden=true>#</a></h3><p>Use <code>then()</code> with an <code>UpdatedProjections</code> parameter to verify which projections were updated:</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>scenario</span><span class=o>-&gt;</span><span class=na>play</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=k>new</span> <span class=nx>Play</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=o>-&gt;</span><span class=na>given</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=k>new</span> <span class=nx>DefineCourseCommand</span><span class=p>(</span><span class=s1>&#39;123&#39;</span><span class=p>,</span> <span class=s1>&#39;PHP Basics&#39;</span><span class=p>,</span> <span class=mi>10</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=k>new</span> <span class=nx>RegisterStudentCommand</span><span class=p>(</span><span class=s1>&#39;1&#39;</span><span class=p>,</span> <span class=s1>&#39;John&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=o>-&gt;</span><span class=na>when</span><span class=p>(</span><span class=k>new</span> <span class=nx>SubscribeStudentToCourseCommand</span><span class=p>(</span><span class=s1>&#39;1&#39;</span><span class=p>,</span> <span class=s1>&#39;123&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=o>-&gt;</span><span class=na>then</span><span class=p>(</span><span class=nx>fn</span> <span class=p>(</span><span class=nx>UpdatedProjections</span> <span class=nv>$projections</span><span class=p>)</span> <span class=o>=&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>assertUpdatedProjectionsContain</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=nx>StudentListProjection</span><span class=o>::</span><span class=na>class</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nv>$projections</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=o>-&gt;</span><span class=na>then</span><span class=p>(</span><span class=k>function</span> <span class=p>(</span><span class=nx>UpdatedProjections</span> <span class=nv>$projections</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// Access updated projections directly
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nv>$studentList</span> <span class=o>=</span> <span class=nv>$projections</span><span class=o>-&gt;</span><span class=na>getAllOf</span><span class=p>(</span><span class=nx>StudentListProjection</span><span class=o>::</span><span class=na>class</span><span class=p>)[</span><span class=mi>0</span><span class=p>];</span>
</span></span><span class=line><span class=cl>            <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>assertStringContainsString</span><span class=p>(</span><span class=s1>&#39;John (PHP Basics)&#39;</span><span class=p>,</span> <span class=p>(</span><span class=nx>string</span><span class=p>)</span> <span class=nv>$studentList</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>);</span></span></span></code></pre></div></figure></div><p>The <code>UpdatedProjections</code> parameter contains projections modified <strong>during the when() phase only</strong>. Projections updated
during given() are not included.</p><p>Use <code>getAllOf()</code> to retrieve all updated projections of a specific type. This returns an array because multiple
projection instances of the same class can be updated in a single play (for example, updating both <code>CourseProjection</code>
for course-123 and <code>CourseProjection</code> for course-456).</p><h3 id=custom-assertions-with-repository>Custom assertions with repository<a href=#custom-assertions-with-repository class=anchor aria-hidden=true>#</a></h3><p>Use <code>then()</code> with a <code>RepositoryInterface</code> parameter to load and verify model state directly:</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>scenario</span><span class=o>-&gt;</span><span class=na>play</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=k>new</span> <span class=nx>Play</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=o>-&gt;</span><span class=na>when</span><span class=p>(</span><span class=k>new</span> <span class=nx>RegisterStudentCommand</span><span class=p>(</span><span class=s1>&#39;1&#39;</span><span class=p>,</span> <span class=s1>&#39;John&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=o>-&gt;</span><span class=na>then</span><span class=p>(</span><span class=k>function</span> <span class=p>(</span><span class=nx>RepositoryInterface</span> <span class=nv>$repo</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nv>$student</span> <span class=o>=</span> <span class=nv>$repo</span><span class=o>-&gt;</span><span class=na>loadModel</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=nx>Student</span><span class=o>::</span><span class=na>class</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nx>Identifier</span><span class=o>::</span><span class=na>is</span><span class=p>(</span><span class=s1>&#39;studentId&#39;</span><span class=p>,</span> <span class=s1>&#39;1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>assertEquals</span><span class=p>(</span><span class=s1>&#39;John&#39;</span><span class=p>,</span> <span class=nv>$student</span><span class=o>-&gt;</span><span class=na>getName</span><span class=p>());</span>
</span></span><span class=line><span class=cl>        <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>);</span></span></span></code></pre></div></figure></div><h3 id=custom-assertions-without-parameters>Custom assertions without parameters<a href=#custom-assertions-without-parameters class=anchor aria-hidden=true>#</a></h3><p>Use <code>then()</code> with no parameters for arbitrary assertion logic:</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>scenario</span><span class=o>-&gt;</span><span class=na>play</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=k>new</span> <span class=nx>Play</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=o>-&gt;</span><span class=na>when</span><span class=p>(</span><span class=k>new</span> <span class=nx>RegisterStudentCommand</span><span class=p>(</span><span class=s1>&#39;1&#39;</span><span class=p>,</span> <span class=s1>&#39;John&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=o>-&gt;</span><span class=na>then</span><span class=p>(</span><span class=k>function</span> <span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nv>$projection</span> <span class=o>=</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>projectionStore</span><span class=o>-&gt;</span><span class=na>find</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=nx>StudentListProjection</span><span class=o>::</span><span class=na>ID</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nx>StudentListProjection</span><span class=o>::</span><span class=na>class</span>
</span></span><span class=line><span class=cl>            <span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>assertStringContainsString</span><span class=p>(</span><span class=s1>&#39;John&#39;</span><span class=p>,</span> <span class=p>(</span><span class=nx>string</span><span class=p>)</span> <span class=nv>$projection</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>);</span></span></span></code></pre></div></figure></div><p>All <code>then()</code> callbacks execute after the when() phase completes, and you can chain multiple <code>then()</code> calls with
different parameter types.</p><h2 id=testing-business-rule-violations>Testing business rule violations<a href=#testing-business-rule-violations class=anchor aria-hidden=true>#</a></h2><p>Test that commands throw exceptions using <code>thenExpectException()</code>:</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=k>use</span> <span class=nx>PHPUnit\Framework\Attributes\DoesNotPerformAssertions</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nx>PHPUnit\Framework\Attributes\Test</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#[Test]
</span></span></span><span class=line><span class=cl><span class=c1>#[DoesNotPerformAssertions]
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>public</span> <span class=k>function</span> <span class=nf>it_prevents_subscription_to_full_course</span><span class=p>()</span><span class=o>:</span> <span class=nx>void</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>scenario</span><span class=o>-&gt;</span><span class=na>play</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=k>new</span> <span class=nx>Play</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=o>-&gt;</span><span class=na>given</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=k>new</span> <span class=nx>DefineCourseCommand</span><span class=p>(</span><span class=s1>&#39;123&#39;</span><span class=p>,</span> <span class=s1>&#39;PHP Basics&#39;</span><span class=p>,</span> <span class=mi>1</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=k>new</span> <span class=nx>RegisterStudentCommand</span><span class=p>(</span><span class=s1>&#39;1&#39;</span><span class=p>,</span> <span class=s1>&#39;John&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=k>new</span> <span class=nx>RegisterStudentCommand</span><span class=p>(</span><span class=s1>&#39;2&#39;</span><span class=p>,</span> <span class=s1>&#39;Alice&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=k>new</span> <span class=nx>SubscribeStudentToCourseCommand</span><span class=p>(</span><span class=s1>&#39;1&#39;</span><span class=p>,</span> <span class=s1>&#39;123&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=o>-&gt;</span><span class=na>when</span><span class=p>(</span><span class=k>new</span> <span class=nx>SubscribeStudentToCourseCommand</span><span class=p>(</span><span class=s1>&#39;2&#39;</span><span class=p>,</span> <span class=s1>&#39;123&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=o>-&gt;</span><span class=na>thenExpectException</span><span class=p>(</span><span class=nx>CourseAtFullCapacityException</span><span class=o>::</span><span class=na>class</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></figure></div><p>When <code>thenExpectException()</code> is used, the test passes only if the expected exception is thrown during the when() phase.
Use the <code>#[DoesNotPerformAssertions]</code> PHPUnit attribute to avoid warnings about tests without assertions.</p><p>Test for specific exception messages using <code>thenExpectExceptionMessage()</code>:</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=c1>#[Test]
</span></span></span><span class=line><span class=cl><span class=c1>#[DoesNotPerformAssertions]
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>public</span> <span class=k>function</span> <span class=nf>it_shows_helpful_error_message_for_full_course</span><span class=p>()</span><span class=o>:</span> <span class=nx>void</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>scenario</span><span class=o>-&gt;</span><span class=na>play</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=k>new</span> <span class=nx>Play</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=o>-&gt;</span><span class=na>given</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=k>new</span> <span class=nx>DefineCourseCommand</span><span class=p>(</span><span class=s1>&#39;123&#39;</span><span class=p>,</span> <span class=s1>&#39;PHP Basics&#39;</span><span class=p>,</span> <span class=mi>1</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=k>new</span> <span class=nx>RegisterStudentCommand</span><span class=p>(</span><span class=s1>&#39;1&#39;</span><span class=p>,</span> <span class=s1>&#39;John&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=k>new</span> <span class=nx>RegisterStudentCommand</span><span class=p>(</span><span class=s1>&#39;2&#39;</span><span class=p>,</span> <span class=s1>&#39;Alice&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=k>new</span> <span class=nx>SubscribeStudentToCourseCommand</span><span class=p>(</span><span class=s1>&#39;1&#39;</span><span class=p>,</span> <span class=s1>&#39;123&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=o>-&gt;</span><span class=na>when</span><span class=p>(</span><span class=k>new</span> <span class=nx>SubscribeStudentToCourseCommand</span><span class=p>(</span><span class=s1>&#39;2&#39;</span><span class=p>,</span> <span class=s1>&#39;123&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=o>-&gt;</span><span class=na>thenExpectExceptionMessage</span><span class=p>(</span><span class=s1>&#39;Course is at full capacity&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></figure></div><h2 id=chaining-multiple-plays>Chaining multiple plays<a href=#chaining-multiple-plays class=anchor aria-hidden=true>#</a></h2><p>A scenario can execute multiple plays sequentially, like acts in a theater piece. Each play represents a distinct phase
of the test:</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=c1>#[Test]
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>public</span> <span class=k>function</span> <span class=nf>it_handles_complete_subscription_lifecycle</span><span class=p>()</span><span class=o>:</span> <span class=nx>void</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>$subscribe</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Play</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=o>-&gt;</span><span class=na>given</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=k>new</span> <span class=nx>DefineCourseCommand</span><span class=p>(</span><span class=s1>&#39;123&#39;</span><span class=p>,</span> <span class=s1>&#39;PHP Basics&#39;</span><span class=p>,</span> <span class=mi>10</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=k>new</span> <span class=nx>RegisterStudentCommand</span><span class=p>(</span><span class=s1>&#39;1&#39;</span><span class=p>,</span> <span class=s1>&#39;John&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=o>-&gt;</span><span class=na>when</span><span class=p>(</span><span class=k>new</span> <span class=nx>SubscribeStudentToCourseCommand</span><span class=p>(</span><span class=s1>&#39;1&#39;</span><span class=p>,</span> <span class=s1>&#39;123&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=o>-&gt;</span><span class=na>then</span><span class=p>(</span><span class=nx>fn</span> <span class=p>(</span><span class=nx>PublishedEvents</span> <span class=nv>$events</span><span class=p>)</span> <span class=o>=&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>assertPublishedEventsContain</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=nx>StudentSubscribedToCourseEvent</span><span class=o>::</span><span class=na>class</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nv>$events</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nv>$unsubscribe</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Play</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=o>-&gt;</span><span class=na>when</span><span class=p>(</span><span class=k>new</span> <span class=nx>UnsubscribeStudentFromCourseCommand</span><span class=p>(</span><span class=s1>&#39;1&#39;</span><span class=p>,</span> <span class=s1>&#39;123&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=o>-&gt;</span><span class=na>then</span><span class=p>(</span><span class=nx>fn</span> <span class=p>(</span><span class=nx>PublishedEvents</span> <span class=nv>$events</span><span class=p>)</span> <span class=o>=&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>assertPublishedEventsContain</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=nx>StudentUnsubscribedFromCourseEvent</span><span class=o>::</span><span class=na>class</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nv>$events</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>scenario</span><span class=o>-&gt;</span><span class=na>play</span><span class=p>(</span><span class=nv>$subscribe</span><span class=p>,</span> <span class=nv>$unsubscribe</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></figure></div><p>Each play executes in order, like acts in a theater piece. The second play (unsubscribe) sees all the effects of the
first play (subscribe), including published events and updated projections. This allows you to test multi-step workflows
while keeping each phase clearly defined and testable.</p><h2 id=complete-scenario-example>Complete scenario example<a href=#complete-scenario-example class=anchor aria-hidden=true>#</a></h2><p>Here&rsquo;s a comprehensive example demonstrating all Play features and assertions:</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=k>use</span> <span class=nx>PHPUnit\Framework\Attributes\DoesNotPerformAssertions</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nx>PHPUnit\Framework\Attributes\Test</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#[Test]
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>public</span> <span class=k>function</span> <span class=nf>it_manages_complete_subscription_workflow</span><span class=p>()</span><span class=o>:</span> <span class=nx>void</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>$studentId</span> <span class=o>=</span> <span class=s1>&#39;1&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nv>$courseId</span> <span class=o>=</span> <span class=s1>&#39;2&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nv>$subscribe</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Play</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=o>-&gt;</span><span class=na>given</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=k>new</span> <span class=nx>CourseDefinedEvent</span><span class=p>(</span><span class=nv>$courseId</span><span class=p>,</span> <span class=s1>&#39;Maths&#39;</span><span class=p>,</span> <span class=mi>30</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=k>new</span> <span class=nx>RegisterStudentCommand</span><span class=p>(</span><span class=nv>$studentId</span><span class=p>,</span> <span class=s1>&#39;John&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=o>-&gt;</span><span class=na>when</span><span class=p>(</span><span class=k>new</span> <span class=nx>SubscribeStudentToCourseCommand</span><span class=p>(</span><span class=nv>$studentId</span><span class=p>,</span> <span class=nv>$courseId</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=o>-&gt;</span><span class=na>when</span><span class=p>(</span><span class=k>function</span> <span class=p>()</span><span class=o>:</span> <span class=nx>void</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>define</span><span class=p>(</span><span class=s1>&#39;MY_CONSTANT&#39;</span><span class=p>,</span> <span class=s1>&#39;some-value&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>})</span>
</span></span><span class=line><span class=cl>        <span class=o>-&gt;</span><span class=na>then</span><span class=p>(</span><span class=k>function</span> <span class=p>(</span><span class=nx>PublishedEvents</span> <span class=nv>$events</span><span class=p>)</span> <span class=k>use</span> <span class=p>(</span><span class=nv>$studentId</span><span class=p>,</span> <span class=nv>$courseId</span><span class=p>)</span><span class=o>:</span> <span class=nx>void</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>assertPublishedEventsCount</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=nv>$events</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>assertPublishedEventsContainOnly</span><span class=p>(</span><span class=nx>StudentSubscribedToCourseEvent</span><span class=o>::</span><span class=na>class</span><span class=p>,</span> <span class=nv>$events</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>assertPublishedEventsDoNotContain</span><span class=p>(</span><span class=nx>StudentUnsubscribedFromCourseEvent</span><span class=o>::</span><span class=na>class</span><span class=p>,</span> <span class=nv>$events</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=sd>/** @var StudentSubscribedToCourseEvent $event */</span>
</span></span><span class=line><span class=cl>            <span class=nv>$event</span> <span class=o>=</span> <span class=nv>$events</span><span class=o>-&gt;</span><span class=na>getAllOf</span><span class=p>(</span><span class=nx>StudentSubscribedToCourseEvent</span><span class=o>::</span><span class=na>class</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span><span class=o>-&gt;</span><span class=na>getEvent</span><span class=p>();</span>
</span></span><span class=line><span class=cl>            <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>assertEquals</span><span class=p>(</span><span class=nv>$studentId</span><span class=p>,</span> <span class=nv>$event</span><span class=o>-&gt;</span><span class=na>studentId</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>assertEquals</span><span class=p>(</span><span class=nv>$courseId</span><span class=p>,</span> <span class=nv>$event</span><span class=o>-&gt;</span><span class=na>courseId</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>})</span>
</span></span><span class=line><span class=cl>        <span class=o>-&gt;</span><span class=na>then</span><span class=p>(</span><span class=nx>fn</span> <span class=p>(</span><span class=nx>UpdatedProjections</span> <span class=nv>$projections</span><span class=p>)</span> <span class=o>=&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>assertUpdatedProjectionsContainExactly</span><span class=p>([</span>
</span></span><span class=line><span class=cl>                <span class=nx>CourseListProjection</span><span class=o>::</span><span class=na>class</span> <span class=o>=&gt;</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nx>StudentListProjection</span><span class=o>::</span><span class=na>class</span> <span class=o>=&gt;</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>],</span> <span class=nv>$projections</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=o>-&gt;</span><span class=na>then</span><span class=p>(</span><span class=nx>fn</span> <span class=p>()</span> <span class=o>=&gt;</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>assertTrue</span><span class=p>(</span><span class=nx>defined</span><span class=p>(</span><span class=s1>&#39;MY_CONSTANT&#39;</span><span class=p>)));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nv>$unsubscribe</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Play</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=o>-&gt;</span><span class=na>when</span><span class=p>(</span><span class=k>new</span> <span class=nx>UnsubscribeStudentFromCourseCommand</span><span class=p>(</span><span class=nv>$studentId</span><span class=p>,</span> <span class=nv>$courseId</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=o>-&gt;</span><span class=na>then</span><span class=p>(</span><span class=nx>fn</span> <span class=p>(</span><span class=nx>PublishedEvents</span> <span class=nv>$events</span><span class=p>)</span> <span class=o>=&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>assertPublishedEventsContainExactly</span><span class=p>([</span>
</span></span><span class=line><span class=cl>                <span class=nx>StudentUnsubscribedFromCourseEvent</span><span class=o>::</span><span class=na>class</span> <span class=o>=&gt;</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>],</span> <span class=nv>$events</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nv>$oops</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Play</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=o>-&gt;</span><span class=na>when</span><span class=p>(</span><span class=k>new</span> <span class=nx>UnsubscribeStudentFromCourseCommand</span><span class=p>(</span><span class=nv>$studentId</span><span class=p>,</span> <span class=nv>$courseId</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=o>-&gt;</span><span class=na>thenExpectException</span><span class=p>(</span><span class=nx>StudentNotSubscribedToCourseException</span><span class=o>::</span><span class=na>class</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>scenario</span><span class=o>-&gt;</span><span class=na>play</span><span class=p>(</span><span class=nv>$subscribe</span><span class=p>,</span> <span class=nv>$unsubscribe</span><span class=p>,</span> <span class=nv>$oops</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></figure></div><p>This example demonstrates:</p><ul><li><strong>given()</strong>: Setting up state with both events and commands</li><li><strong>when()</strong>: Executing commands and arbitrary actions</li><li><strong>then()</strong> with <strong>PublishedEvents</strong>: Comprehensive event assertions including count, type, and content verification</li><li><strong>then()</strong> with <strong>UpdatedProjections</strong>: Verifying projection updates with exact counts</li><li><strong>then()</strong> with <strong>no parameters</strong>: Custom assertion logic</li><li><strong>thenExpectException()</strong>: Testing business rule violations</li><li><strong>Multiple plays</strong>: Three sequential plays representing different phases of the workflow</li></ul><h2 id=optimizing-test-performance-with-event-publishing-modes>Optimizing test performance with event publishing modes<a href=#optimizing-test-performance-with-event-publishing-modes class=anchor aria-hidden=true>#</a></h2><p>By default, events generated in both <code>given()</code> and <code>when()</code> phases are published to the event bus, which triggers
projection updates. This ensures backwards compatibility and predictable behavior. However, for better performance, you
can optimize when events are published.</p><h3 id=automatic-projection-detection-detect-mode>Automatic projection detection (DETECT mode)<a href=#automatic-projection-detection-detect-mode class=anchor aria-hidden=true>#</a></h3><p>The <code>EventPublishingMode::DETECT</code> mode automatically analyzes your test to determine if projections are needed:</p><ul><li>Events in <code>given()</code> are <strong>NOT published</strong> (test setup only)</li><li>Events in <code>when()</code> are <strong>published only if</strong> your assertions reference <code>UpdatedProjections</code></li><li>More efficient as projections are only updated when actually needed for assertions</li></ul><p>Enable this mode at the scenario level:</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=k>use</span> <span class=nx>Backslash\Scenario\EventPublishingMode</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>StudentTest</span> <span class=k>extends</span> <span class=nx>TestCase</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=nx>Scenario</span> <span class=nv>$scenario</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>protected</span> <span class=k>function</span> <span class=nf>setUp</span><span class=p>()</span><span class=o>:</span> <span class=nx>void</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>scenario</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Scenario</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>scenario</span><span class=o>-&gt;</span><span class=na>setEventPublishingMode</span><span class=p>(</span><span class=nx>EventPublishingMode</span><span class=o>::</span><span class=na>DETECT</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></figure></div><p>With DETECT mode enabled, this test will NOT publish events during <code>given()</code>, and WILL publish during <code>when()</code> because
it asserts on projections:</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=c1>#[Test]
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>public</span> <span class=k>function</span> <span class=nf>it_updates_student_projection</span><span class=p>()</span><span class=o>:</span> <span class=nx>void</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>scenario</span><span class=o>-&gt;</span><span class=na>play</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=k>new</span> <span class=nx>Play</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=o>-&gt;</span><span class=na>given</span><span class=p>(</span><span class=k>new</span> <span class=nx>StudentRegisteredEvent</span><span class=p>(</span><span class=s1>&#39;1&#39;</span><span class=p>,</span> <span class=s1>&#39;John&#39;</span><span class=p>))</span>  <span class=c1>// NOT published
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=o>-&gt;</span><span class=na>when</span><span class=p>(</span><span class=k>function</span> <span class=p>(</span><span class=nx>RepositoryInterface</span> <span class=nv>$repo</span><span class=p>)</span><span class=o>:</span> <span class=nx>void</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nv>$student</span> <span class=o>=</span> <span class=nv>$repo</span><span class=o>-&gt;</span><span class=na>loadModel</span><span class=p>(</span><span class=nx>Student</span><span class=o>::</span><span class=na>class</span><span class=p>,</span> <span class=nx>Identifier</span><span class=o>::</span><span class=na>is</span><span class=p>(</span><span class=s1>&#39;studentId&#39;</span><span class=p>,</span> <span class=s1>&#39;1&#39;</span><span class=p>));</span>
</span></span><span class=line><span class=cl>                <span class=nv>$student</span><span class=o>-&gt;</span><span class=na>changeName</span><span class=p>(</span><span class=s1>&#39;Jane&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=nv>$repo</span><span class=o>-&gt;</span><span class=na>storeChanges</span><span class=p>(</span><span class=nv>$student</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>})</span>  <span class=c1>// WILL be published because of UpdatedProjections below
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=o>-&gt;</span><span class=na>then</span><span class=p>(</span><span class=nx>fn</span> <span class=p>(</span><span class=nx>UpdatedProjections</span> <span class=nv>$projections</span><span class=p>)</span> <span class=o>=&gt;</span>
</span></span><span class=line><span class=cl>                <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>assertUpdatedProjectionsContain</span><span class=p>(</span><span class=nx>StudentProjection</span><span class=o>::</span><span class=na>class</span><span class=p>,</span> <span class=nv>$projections</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></figure></div><h3 id=changing-modes-for-specific-tests>Changing modes for specific tests<a href=#changing-modes-for-specific-tests class=anchor aria-hidden=true>#</a></h3><p>You can change the publishing mode at any time by calling <code>setEventPublishingMode()</code> on the scenario:</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=c1>#[Test]
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>public</span> <span class=k>function</span> <span class=nf>it_always_publishes_events</span><span class=p>()</span><span class=o>:</span> <span class=nx>void</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Force event publishing for this specific test
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>scenario</span><span class=o>-&gt;</span><span class=na>setEventPublishingMode</span><span class=p>(</span><span class=nx>EventPublishingMode</span><span class=o>::</span><span class=na>ALWAYS</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>scenario</span><span class=o>-&gt;</span><span class=na>play</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=k>new</span> <span class=nx>Play</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=o>-&gt;</span><span class=na>given</span><span class=p>(</span><span class=k>new</span> <span class=nx>StudentRegisteredEvent</span><span class=p>(</span><span class=s1>&#39;1&#39;</span><span class=p>,</span> <span class=s1>&#39;John&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=o>-&gt;</span><span class=na>when</span><span class=p>(</span><span class=k>new</span> <span class=nx>ChangeNameCommand</span><span class=p>(</span><span class=s1>&#39;1&#39;</span><span class=p>,</span> <span class=s1>&#39;Jane&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=o>-&gt;</span><span class=na>then</span><span class=p>(</span><span class=nx>fn</span> <span class=p>(</span><span class=nx>PublishedEvents</span> <span class=nv>$events</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=o>...</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#[Test]
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>public</span> <span class=k>function</span> <span class=nf>it_never_publishes_events</span><span class=p>()</span><span class=o>:</span> <span class=nx>void</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Prevent all event publishing for this test
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>scenario</span><span class=o>-&gt;</span><span class=na>setEventPublishingMode</span><span class=p>(</span><span class=nx>EventPublishingMode</span><span class=o>::</span><span class=na>NEVER</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>scenario</span><span class=o>-&gt;</span><span class=na>play</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=k>new</span> <span class=nx>Play</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=o>-&gt;</span><span class=na>given</span><span class=p>(</span><span class=k>new</span> <span class=nx>StudentRegisteredEvent</span><span class=p>(</span><span class=s1>&#39;1&#39;</span><span class=p>,</span> <span class=s1>&#39;John&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=o>-&gt;</span><span class=na>when</span><span class=p>(</span><span class=k>new</span> <span class=nx>ChangeNameCommand</span><span class=p>(</span><span class=s1>&#39;1&#39;</span><span class=p>,</span> <span class=s1>&#39;Jane&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=o>-&gt;</span><span class=na>then</span><span class=p>(</span><span class=nx>fn</span> <span class=p>(</span><span class=nx>PublishedEvents</span> <span class=nv>$events</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=o>...</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></figure></div><p>Note that the mode applies to all plays executed after it&rsquo;s set, until you change it again.</p><h3 id=available-modes>Available modes<a href=#available-modes class=anchor aria-hidden=true>#</a></h3><p>The <code>EventPublishingMode</code> enum provides three modes:</p><ul><li><strong>ALWAYS</strong> (default): Events are published in both <code>given()</code> and <code>when()</code> phases, ensuring projections are always
updated. Guarantees backwards compatibility.</li><li><strong>DETECT</strong>: Automatically determines if projections are needed by analyzing your <code>then()</code> assertions. Events in
<code>given()</code> are not published; events in <code>when()</code> are published only if needed.</li><li><strong>NEVER</strong>: Events are never published to the event bus. Use this for pure event store testing without any projection
updates.</li></ul><p>Choose DETECT mode for better test performance when you don&rsquo;t need projections updated during setup, or stick with
ALWAYS for simpler, more predictable behavior.</p><h2 id=using-assertionstrait>Using AssertionsTrait<a href=#using-assertionstrait class=anchor aria-hidden=true>#</a></h2><p>The <code>AssertionsTrait</code> (included in your base test case) provides helpful assertions for working with scenarios:</p><p><strong>Event assertions:</strong></p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=c1>// Assert an event was published
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>assertPublishedEventsContain</span><span class=p>(</span><span class=nx>CourseDefinedEvent</span><span class=o>::</span><span class=na>class</span><span class=p>,</span> <span class=nv>$events</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Assert only a specific event type was published
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>assertPublishedEventsContainOnly</span><span class=p>(</span><span class=nx>CourseDefinedEvent</span><span class=o>::</span><span class=na>class</span><span class=p>,</span> <span class=nv>$events</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Assert exact count of specific events
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>assertPublishedEventsContainExactly</span><span class=p>([</span>
</span></span><span class=line><span class=cl>    <span class=nx>CourseDefinedEvent</span><span class=o>::</span><span class=na>class</span> <span class=o>=&gt;</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>CourseCapacityChangedEvent</span><span class=o>::</span><span class=na>class</span> <span class=o>=&gt;</span> <span class=mi>2</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>],</span> <span class=nv>$events</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Assert total event count
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>assertPublishedEventsCount</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=nv>$events</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Assert an event was NOT published
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>assertPublishedEventsDoNotContain</span><span class=p>(</span><span class=nx>CourseDeletedEvent</span><span class=o>::</span><span class=na>class</span><span class=p>,</span> <span class=nv>$events</span><span class=p>);</span></span></span></code></pre></div></figure></div><p><strong>Projection assertions:</strong></p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=c1>// Assert a projection was updated
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>assertUpdatedProjectionsContain</span><span class=p>(</span><span class=nx>CourseProjection</span><span class=o>::</span><span class=na>class</span><span class=p>,</span> <span class=nv>$projections</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Assert only a specific projection type was updated
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>assertUpdatedProjectionsContainOnly</span><span class=p>(</span><span class=nx>CourseProjection</span><span class=o>::</span><span class=na>class</span><span class=p>,</span> <span class=nv>$projections</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Assert exact count of updated projections
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>assertUpdatedProjectionsContainExactly</span><span class=p>([</span>
</span></span><span class=line><span class=cl>    <span class=nx>CourseProjection</span><span class=o>::</span><span class=na>class</span> <span class=o>=&gt;</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>StudentProjection</span><span class=o>::</span><span class=na>class</span> <span class=o>=&gt;</span> <span class=mi>2</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>],</span> <span class=nv>$projections</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Assert total projection update count
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>assertUpdatedProjectionsCount</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=nv>$projections</span><span class=p>);</span></span></span></code></pre></div></figure></div><h2 id=chaining-play-methods>Chaining Play methods<a href=#chaining-play-methods class=anchor aria-hidden=true>#</a></h2><p>All Play methods return a new instance, allowing fluent chaining in the Given-When-Then pattern:</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=c1>#[Test]
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>public</span> <span class=k>function</span> <span class=nf>it_changes_course_capacity_and_updates_projection</span><span class=p>()</span><span class=o>:</span> <span class=nx>void</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>scenario</span><span class=o>-&gt;</span><span class=na>play</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=k>new</span> <span class=nx>Play</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=o>-&gt;</span><span class=na>given</span><span class=p>(</span><span class=k>new</span> <span class=nx>DefineCourseCommand</span><span class=p>(</span><span class=s1>&#39;123&#39;</span><span class=p>,</span> <span class=s1>&#39;PHP Basics&#39;</span><span class=p>,</span> <span class=mi>10</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=o>-&gt;</span><span class=na>when</span><span class=p>(</span><span class=k>new</span> <span class=nx>ChangeCourseCapacityCommand</span><span class=p>(</span><span class=s1>&#39;123&#39;</span><span class=p>,</span> <span class=mi>20</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=o>-&gt;</span><span class=na>then</span><span class=p>(</span><span class=nx>fn</span> <span class=p>(</span><span class=nx>PublishedEvents</span> <span class=nv>$events</span><span class=p>)</span> <span class=o>=&gt;</span>
</span></span><span class=line><span class=cl>                <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>assertPublishedEventsCount</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=nv>$events</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=o>-&gt;</span><span class=na>then</span><span class=p>(</span><span class=nx>fn</span> <span class=p>(</span><span class=nx>UpdatedProjections</span> <span class=nv>$projections</span><span class=p>)</span> <span class=o>=&gt;</span>
</span></span><span class=line><span class=cl>                <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>assertUpdatedProjectionsContain</span><span class=p>(</span><span class=nx>CourseProjection</span><span class=o>::</span><span class=na>class</span><span class=p>,</span> <span class=nv>$projections</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=o>-&gt;</span><span class=na>then</span><span class=p>(</span><span class=k>function</span> <span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nv>$projection</span> <span class=o>=</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>projectionStore</span><span class=o>-&gt;</span><span class=na>find</span><span class=p>(</span><span class=s1>&#39;123&#39;</span><span class=p>,</span> <span class=nx>CourseProjection</span><span class=o>::</span><span class=na>class</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>assertEquals</span><span class=p>(</span><span class=mi>20</span><span class=p>,</span> <span class=nv>$projection</span><span class=o>-&gt;</span><span class=na>getCapacity</span><span class=p>());</span>
</span></span><span class=line><span class=cl>            <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></figure></div><h2 id=testing-models-in-isolation>Testing models in isolation<a href=#testing-models-in-isolation class=anchor aria-hidden=true>#</a></h2><p>You can test models directly without scenarios for unit-level tests:</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=k>use</span> <span class=nx>PHPUnit\Framework\Attributes\Test</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#[Test]
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>public</span> <span class=k>function</span> <span class=nf>it_enforces_course_capacity_rules</span><span class=p>()</span><span class=o>:</span> <span class=nx>void</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>$model</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>CourseCapacityModel</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Apply initial state
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nv>$initialEvents</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>RecordedEventStream</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=nx>RecordedEvent</span><span class=o>::</span><span class=na>create</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=k>new</span> <span class=nx>CourseDefinedEvent</span><span class=p>(</span><span class=s1>&#39;course-123&#39;</span><span class=p>,</span> <span class=s1>&#39;PHP Basics&#39;</span><span class=p>,</span> <span class=mi>10</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=k>new</span> <span class=nx>Metadata</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>            <span class=k>new</span> <span class=nx>DateTimeImmutable</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nv>$model</span><span class=o>-&gt;</span><span class=na>applyEvents</span><span class=p>(</span><span class=nv>$initialEvents</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Execute business logic
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nv>$model</span><span class=o>-&gt;</span><span class=na>change</span><span class=p>(</span><span class=mi>20</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Assert recorded events
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nv>$changes</span> <span class=o>=</span> <span class=nv>$model</span><span class=o>-&gt;</span><span class=na>getChanges</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>assertCount</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=nv>$changes</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nv>$recordedEvent</span> <span class=o>=</span> <span class=nx>iterator_to_array</span><span class=p>(</span><span class=nv>$changes</span><span class=p>)[</span><span class=mi>0</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>assertInstanceOf</span><span class=p>(</span><span class=nx>CourseCapacityChangedEvent</span><span class=o>::</span><span class=na>class</span><span class=p>,</span> <span class=nv>$recordedEvent</span><span class=o>-&gt;</span><span class=na>getEvent</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></figure></div><p>This approach tests model logic in isolation without involving the command dispatcher, event bus, or projections. Use
<code>applyEvents()</code> with a <code>RecordedEventStream</code> to set up the model&rsquo;s initial state, just like <code>given()</code> with events in
scenarios.</p><h2 id=best-practices>Best practices<a href=#best-practices class=anchor aria-hidden=true>#</a></h2><p><strong>Use the Given-When-Then pattern.</strong> Structure your tests with <code>given()</code> for setup, <code>when()</code> for actions, and <code>then()</code>
for assertions. This makes tests readable and self-documenting.</p><p><strong>Set up state with given().</strong> Use <code>given()</code> to establish initial state with both events and commands. This ensures a
clean separation between setup and the actual test action.</p><p><strong>Keep scenarios focused.</strong> Each test should verify one behavior; avoid testing multiple unrelated behaviors in a single
scenario. Name tests with <code>it_</code> prefix describing the expected behavior (e.g., <code>it_publishes_event_when_registering_student</code>).</p><p><strong>Test both success and failure.</strong> Write scenarios for both successful operations and business rule violations using
<code>thenExpectException()</code>.</p><p><strong>Leverage AssertionsTrait.</strong> Use the provided assertions (<code>assertPublishedEventsContain()</code>,
<code>assertUpdatedProjectionsContain()</code>) rather than writing custom assertion logic.</p><p><strong>Chain multiple plays for workflows.</strong> When testing multi-step processes, create separate plays for each step and
execute them together via <code>scenario->play($play1, $play2)</code>.</p><p><strong>Use #[DoesNotPerformAssertions] for exception tests.</strong> When using <code>thenExpectException()</code> without additional
assertions, add the <code>#[DoesNotPerformAssertions]</code> PHPUnit attribute to avoid warnings about tests without assertions.</p><p><strong>Use #[Test] attribute.</strong> Prefer the modern <code>#[Test]</code> attribute over the <code>test_</code> prefix or <code>@test</code> docblock annotation
for marking test methods.</p><p><strong>Optimize with DETECT mode.</strong> For better test performance, enable <code>EventPublishingMode::DETECT</code> at the scenario level
to avoid unnecessary projection updates during setup. Only use ALWAYS mode when you need projections updated during <code>given()</code>.</p><p><strong>Type-hint then() parameters.</strong> Always type-hint the parameter in <code>then()</code> callbacks to enable automatic routing:
<code>then(fn (PublishedEvents $events) => ...)</code> instead of <code>then(fn ($events) => ...)</code>.</p><hr><div class="page-footer-meta d-flex flex-column flex-md-row justify-content-between"></div><div class="page-nav d-flex flex-column flex-sm-row"><div class="card w-100"><div class="card-body d-flex"><div class="d-flex flex-column justify-content-center"><svg class="icon icon-tabler icon-tabler-arrow-left" width="20" height="20" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 12h14"/><path d="M5 12l6 6"/><path d="M5 12l6-6"/></svg></div><div class="d-flex flex-column"><div class=text-body-secondary>Prev</div><a href=/docs/application-setup/registering-handlers/ class="stretched-link text-reset text-decoration-none">Registering Handlers</a></div></div></div><div class=m-2></div><div class="card text-end w-100"><div class="card-body d-flex justify-content-end"><div class="d-flex flex-column"><div class=text-body-secondary>Next</div><a href=/docs/getting-started/quick-start-guide/ class="stretched-link text-reset text-decoration-none">Quick Start Guide</a></div><div class="d-flex flex-column justify-content-center"><svg class="icon icon-tabler icon-tabler-arrow-right" width="20" height="20" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 12h14"/><path d="M13 18l6-6"/><path d="M13 6l6 6"/></svg></div></div></div></div></main></div></div></div><footer class="footer text-muted"><div class=container-lg><div class=row><div class="col-lg-8 text-center text-lg-start"><ul class=list-inline></ul></div><div class="col-lg-8 text-center text-lg-end"><ul class=list-inline><li class=list-inline-item></li></ul></div></div></div></footer><script async src=/js/app.19b73e0182301dd61c9211c2f6890104740e2eb9eb12fe4ba8d4f31435b22ed6.js integrity="sha256-Gbc+AYIwHdYckhHC9okBBHQOLrnrEv5LqNTzFDWyLtY="></script><script async src=/js/flexsearch.5dd6433c29c3e043627f046054aed58ff3790f58fdb8423f45125bbafdcad335.js integrity="sha256-XdZDPCnD4ENifwRgVK7Vj/N5D1j9uEI/RRJbuv3K0zU="></script><script async src=/js/search-modal.96e662d8f691fe25c859a3437074b485f2d7bed0bca612725028c6cf4322e2f2.js integrity="sha256-luZi2PaR/iXIWaNDcHS0hfLXvtC8phJyUCjGz0Mi4vI="></script><div class="d-inline-flex fixed-bottom-right pb-4 pe-4"><button id=toTop type=button class="btn btn-primary rounded-circle ms-auto p-2"><span class=visually-hidden>Top</span><svg class="icon icon-tabler icon-tabler-chevron-up" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6 15l6-6 6 6"/></svg></button></div></body></html>