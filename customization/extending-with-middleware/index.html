<!doctype html><html lang=en-ca dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Extending with Middleware#
Middleware provides a powerful way to add cross-cutting concerns to Backslash components. It follows an onion layer
model, allowing logic to be executed before and after core operations.
Understanding middleware#
Middleware wraps component operations in layers. Each middleware can:

Execute logic before delegating to the next layer
Execute logic after the next layer completes
Transform inputs or outputs
Handle errors or side effects

The onion layer model ensures symmetric execution:"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://backslashphp.github.io/customization/extending-with-middleware/"><meta property="og:site_name" content="Backslash PHP Developer Guide"><meta property="og:title" content="Extending with Middleware"><meta property="og:description" content="Extending with Middleware# Middleware provides a powerful way to add cross-cutting concerns to Backslash components. It follows an onion layer model, allowing logic to be executed before and after core operations.
Understanding middleware# Middleware wraps component operations in layers. Each middleware can:
Execute logic before delegating to the next layer Execute logic after the next layer completes Transform inputs or outputs Handle errors or side effects The onion layer model ensures symmetric execution:"><meta property="og:locale" content="en_ca"><meta property="og:type" content="article"><meta property="article:section" content="customization"><meta property="article:modified_time" content="2025-11-11T17:09:05-05:00"><title>Extending with Middleware | Backslash PHP Developer Guide</title><link rel=icon href=/favicon.png><link rel=manifest href=/manifest.json><link rel=canonical href=https://backslashphp.github.io/customization/extending-with-middleware/><link rel=stylesheet href=/book.min.c0e41de750417a94c4724981669dbe7955cfa422e1b2a84d4d2ac5e7d4a300f2.css integrity="sha256-wOQd51BBepTEckmBZp2+eVXPpCLhsqhNTSrF59SjAPI=" crossorigin=anonymous><script defer src=/fuse.min.js></script><script defer src=/en.search.min.df1fbe8819e5bb350af20e1db8be30468b53a76095af3d606a1cca072d432dbb.js integrity="sha256-3x++iBnluzUK8g4duL4wRotTp2CVrz1gahzKBy1DLbs=" crossorigin=anonymous></script></head><body dir=ltr class="book-kind-page book-type-customization"><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>Backslash PHP Developer Guide</span></a></h2><div class="book-search hidden"><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script><ul><li><a href=https://github.com/backslashphp/backslash target=_blank rel=noopener>Source code</a></li><li><a href=https://github.com/backslashphp/demo target=_blank rel=noopener>Demo application</a></li></ul><ul><li class=book-section-flat><a>Getting Started</a><ul><li><a href=/getting-started/introduction/>Introduction</a></li><li><a href=/getting-started/architecture-overview/>Architecture Overview</a></li><li><a href=/getting-started/quick-start-guide/>Quick Start Guide</a></li></ul></li><li class=book-section-flat><a>Event Sourcing</a><ul><li><a href=/event-sourcing/understanding-event-sourcing/>Understanding Event Sourcing</a></li><li><a href=/event-sourcing/defining-events/>Defining Events</a></li><li><a href=/event-sourcing/querying-events/>Querying Events</a></li><li><a href=/event-sourcing/building-models/>Building Models</a></li></ul></li><li class=book-section-flat><a>Commands and Projections (CQRS)</a><ul><li><a href=/cqrs/understanding-cqrs/>Understanding CQRS</a></li><li><a href=/cqrs/dispatching-commands/>Dispatching Commands</a></li><li><a href=/cqrs/reacting-with-event-handlers/>Reacting with Event Handlers</a></li><li><a href=/cqrs/building-projections/>Building Projections</a></li></ul></li><li class=book-section-flat><a>Testing Your Application</a><ul><li><a href=/testing/setting-up-tests/>Setting Up Tests</a></li><li><a href=/testing/writing-test-scenarios/>Writing Test Scenarios</a></li></ul></li><li class=book-section-flat><a>Customization</a><ul><li><a href=/customization/extending-with-middleware/ class=active>Extending with Middleware</a></li><li><a href=/customization/enriching-event-streams/>Enriching Event Streams</a></li></ul></li><li class=book-section-flat><a>Application Setup</a><ul><li><a href=/application-setup/defining-services/>Defining Services</a></li><li><a href=/application-setup/registering-handlers/>Registering Handlers</a></li><li><a href=/application-setup/using-the-bootstrap-file/>Using the Bootstrap File</a></li></ul></li><li class=book-section-flat><a>Maintenance</a><ul><li><a href=/maintenance/rebuilding-projections/>Rebuilding Projections</a></li></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class="book-header hidden"><div class="flex align-center justify-between"><label for=menu-control><img src=/icons/menu.svg class=book-icon alt=Menu></label><h3>Extending with Middleware</h3><label for=toc-control><img src=/icons/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class=hidden><nav id=TableOfContents><ul><li><a href=#understanding-middleware>Understanding middleware</a></li><li><a href=#commanddispatcher-middleware>CommandDispatcher middleware</a></li><li><a href=#eventstore-middleware>EventStore middleware</a></li><li><a href=#eventbus-middleware>EventBus middleware</a></li><li><a href=#projectionstore-middleware>ProjectionStore middleware</a></li><li><a href=#repository-middleware>Repository middleware</a></li><li><a href=#built-in-middleware>Built-in middleware</a></li><li><a href=#middleware-execution-order>Middleware execution order</a></li><li><a href=#best-practices>Best practices</a></li></ul></nav></aside></header><article class="markdown book-article"><h1 id=extending-with-middleware>Extending with Middleware<a class=anchor href=#extending-with-middleware>#</a></h1><p>Middleware provides a powerful way to add cross-cutting concerns to Backslash components. It follows an onion layer
model, allowing logic to be executed before and after core operations.</p><h2 id=understanding-middleware>Understanding middleware<a class=anchor href=#understanding-middleware>#</a></h2><p>Middleware wraps component operations in layers. Each middleware can:</p><ul><li>Execute logic before delegating to the next layer</li><li>Execute logic after the next layer completes</li><li>Transform inputs or outputs</li><li>Handle errors or side effects</li></ul><p>The onion layer model ensures symmetric execution:</p><pre tabindex=0><code>Outer Layer → Middle Layer → Inner Layer → [Core] → Inner Layer → Middle Layer → Outer Layer</code></pre><p>Multiple Backslash core components support middleware extension:</p><ul><li><strong>Dispatcher</strong></li><li><strong>EventBus</strong></li><li><strong>EventNameResolver</strong></li><li><strong>EventStore</strong></li><li><strong>ProjectionStore</strong></li><li><strong>Repository</strong></li><li><strong>Serializer</strong> (dependency of ProjectionStore and EventStore for serializing projections and events to text)</li></ul><h2 id=commanddispatcher-middleware>CommandDispatcher middleware<a class=anchor href=#commanddispatcher-middleware>#</a></h2><p>Dispatcher middleware wraps command dispatch. Common use cases include logging commands or handling errors:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#66d9ef>use</span> <span style=color:#a6e22e>Backslash\CommandDispatcher\DispatcherInterface</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> <span style=color:#a6e22e>Backslash\CommandDispatcher\MiddlewareInterface</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>LoggingCommandDispatcherMiddleware</span> <span style=color:#66d9ef>implements</span> <span style=color:#a6e22e>MiddlewareInterface</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>__construct</span>(
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>LoggerInterface</span> $logger,
</span></span><span style=display:flex><span>    ) {
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>dispatch</span>(<span style=color:#a6e22e>object</span> $command, <span style=color:#a6e22e>DispatcherInterface</span> $next)<span style=color:#f92672>:</span> <span style=color:#a6e22e>void</span>
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>logger</span><span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>info</span>(<span style=color:#e6db74>&#39;Dispatching command&#39;</span>, [
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;command&#39;</span> <span style=color:#f92672>=&gt;</span> $command<span style=color:#f92672>::</span><span style=color:#a6e22e>class</span>,
</span></span><span style=display:flex><span>        ]);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>            $next<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>dispatch</span>($command);
</span></span><span style=display:flex><span>            $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>logger</span><span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>info</span>(<span style=color:#e6db74>&#39;Command completed successfully&#39;</span>);
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>Throwable</span> $e) {
</span></span><span style=display:flex><span>            $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>logger</span><span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>error</span>(<span style=color:#e6db74>&#39;Command failed&#39;</span>, [
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#39;error&#39;</span> <span style=color:#f92672>=&gt;</span> $e<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>getMessage</span>(),
</span></span><span style=display:flex><span>            ]);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> $e;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}</span></span></code></pre></td></tr></table></div></div><p>Register it with the dispatcher:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span>$dispatcher<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>addMiddleware</span>(<span style=color:#66d9ef>new</span> <span style=color:#a6e22e>LoggingCommandDispatcherMiddleware</span>($logger));</span></span></code></pre></td></tr></table></div></div><h2 id=eventstore-middleware>EventStore middleware<a class=anchor href=#eventstore-middleware>#</a></h2><p>EventStore middleware wraps access to the storage adapter.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#66d9ef>use</span> <span style=color:#a6e22e>Backslash\EventStore\MiddlewareInterface</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> <span style=color:#a6e22e>Backslash\EventStore\EventStoreInterface</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> <span style=color:#a6e22e>Backslash\Event\RecordedEventStream</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> <span style=color:#a6e22e>Backslash\EventStore\Query\QueryInterface</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>StreamEnricherEventStoreMiddleware</span> <span style=color:#66d9ef>implements</span> <span style=color:#a6e22e>MiddlewareInterface</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>__construct</span>(
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>StreamEnricherInterface</span> $enricher,
</span></span><span style=display:flex><span>    ) {
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>append</span>(
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>RecordedEventStream</span> $stream,
</span></span><span style=display:flex><span>        <span style=color:#f92672>?</span><span style=color:#a6e22e>QueryInterface</span> $concurrencyCheck,
</span></span><span style=display:flex><span>        <span style=color:#f92672>?</span><span style=color:#a6e22e>int</span> $expectedSequence,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>EventStoreInterface</span> $next
</span></span><span style=display:flex><span>    )<span style=color:#f92672>:</span> <span style=color:#a6e22e>void</span> {
</span></span><span style=display:flex><span>        $enrichedStream <span style=color:#f92672>=</span> $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>enricher</span><span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>enrich</span>($stream);
</span></span><span style=display:flex><span>        $next<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>append</span>($enrichedStream, $concurrencyCheck, $expectedSequence);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>fetch</span>(
</span></span><span style=display:flex><span>        <span style=color:#f92672>?</span><span style=color:#a6e22e>QueryInterface</span> $query,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>int</span> $fromSequence,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>EventStoreInterface</span> $next
</span></span><span style=display:flex><span>    )<span style=color:#f92672>:</span> <span style=color:#a6e22e>StoredRecordedEventStream</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> $next<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>fetch</span>($query, $fromSequence);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>inspect</span>(<span style=color:#a6e22e>InspectorInterface</span> $inspector, <span style=color:#a6e22e>EventStoreInterface</span> $next)<span style=color:#f92672>:</span> <span style=color:#a6e22e>void</span>
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        $next<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>inspect</span>($inspector);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>purge</span>(<span style=color:#a6e22e>EventStoreInterface</span> $next)<span style=color:#f92672>:</span> <span style=color:#a6e22e>void</span>
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        $next<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>purge</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}</span></span></code></pre></td></tr></table></div></div><p>Register it with the EventStore:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span>$eventStore<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>addMiddleware</span>(<span style=color:#66d9ef>new</span> <span style=color:#a6e22e>StreamEnricherEventStoreMiddleware</span>($enricher));</span></span></code></pre></td></tr></table></div></div><h2 id=eventbus-middleware>EventBus middleware<a class=anchor href=#eventbus-middleware>#</a></h2><p>EventBus middleware wraps event publishing. Common use cases include enriching events before broadcasting them:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#66d9ef>use</span> <span style=color:#a6e22e>Backslash\EventBus\MiddlewareInterface</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> <span style=color:#a6e22e>Backslash\EventBus\EventBusInterface</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> <span style=color:#a6e22e>Backslash\Event\RecordedEventStream</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>StreamEnricherEventBusMiddleware</span> <span style=color:#66d9ef>implements</span> <span style=color:#a6e22e>MiddlewareInterface</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>__construct</span>(
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>StreamEnricherInterface</span> $enricher,
</span></span><span style=display:flex><span>    ) {
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>publish</span>(
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>RecordedEventStream</span> $stream,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>EventBusInterface</span> $next
</span></span><span style=display:flex><span>    )<span style=color:#f92672>:</span> <span style=color:#a6e22e>void</span> {
</span></span><span style=display:flex><span>        $enrichedStream <span style=color:#f92672>=</span> $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>enricher</span><span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>enrich</span>($stream);
</span></span><span style=display:flex><span>        $next<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>publish</span>($enrichedStream);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}</span></span></code></pre></td></tr></table></div></div><p>Register it with the EventBus:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span>$eventBus<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>addMiddleware</span>(<span style=color:#66d9ef>new</span> <span style=color:#a6e22e>StreamEnricherEventBusMiddleware</span>($enricher));</span></span></code></pre></td></tr></table></div></div><h2 id=projectionstore-middleware>ProjectionStore middleware<a class=anchor href=#projectionstore-middleware>#</a></h2><p>ProjectionStore middleware wraps access to the storage adapter.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#66d9ef>use</span> <span style=color:#a6e22e>Backslash\ProjectionStore\MiddlewareInterface</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> <span style=color:#a6e22e>Backslash\ProjectionStore\ProjectionStoreInterface</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> <span style=color:#a6e22e>Backslash\Projection\ProjectionInterface</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>LoggingProjectionStoreMiddleware</span> <span style=color:#66d9ef>implements</span> <span style=color:#a6e22e>MiddlewareInterface</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>__construct</span>(
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>LoggerInterface</span> $logger,
</span></span><span style=display:flex><span>    ) {
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>find</span>(<span style=color:#a6e22e>string</span> $id, <span style=color:#a6e22e>string</span> $class, <span style=color:#a6e22e>ProjectionStoreInterface</span> $next)<span style=color:#f92672>:</span> <span style=color:#a6e22e>ProjectionInterface</span>
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>logger</span><span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>debug</span>(<span style=color:#e6db74>&#39;Loading projection&#39;</span>, [<span style=color:#e6db74>&#39;id&#39;</span> <span style=color:#f92672>=&gt;</span> $id, <span style=color:#e6db74>&#39;class&#39;</span> <span style=color:#f92672>=&gt;</span> $class]);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> $next<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>find</span>($id, $class);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>has</span>(<span style=color:#a6e22e>string</span> $id, <span style=color:#a6e22e>string</span> $class, <span style=color:#a6e22e>ProjectionStoreInterface</span> $next)<span style=color:#f92672>:</span> <span style=color:#a6e22e>bool</span>
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> $next<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>has</span>($id, $class);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>store</span>(<span style=color:#a6e22e>ProjectionInterface</span> $projection, <span style=color:#a6e22e>ProjectionStoreInterface</span> $next)<span style=color:#f92672>:</span> <span style=color:#a6e22e>void</span>
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>logger</span><span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>debug</span>(<span style=color:#e6db74>&#39;Storing projection&#39;</span>, [<span style=color:#e6db74>&#39;class&#39;</span> <span style=color:#f92672>=&gt;</span> $projection<span style=color:#f92672>::</span><span style=color:#a6e22e>class</span>]);
</span></span><span style=display:flex><span>        $next<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>store</span>($projection);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Implement other required methods...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}</span></span></code></pre></td></tr></table></div></div><h2 id=repository-middleware>Repository middleware<a class=anchor href=#repository-middleware>#</a></h2><p>Repository middleware wraps model loading and changes persistence. Common use cases include modifying queries to apply
additional conditions, such as tenant scoping in multi-tenant applications.</p><p>The following example shows a middleware that adds tenant filtering to all queries, avoiding the need to repeat this
condition in every query throughout the application:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#66d9ef>use</span> <span style=color:#a6e22e>Backslash\Repository\MiddlewareInterface</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> <span style=color:#a6e22e>Backslash\Repository\RepositoryInterface</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> <span style=color:#a6e22e>Backslash\Model\ModelInterface</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> <span style=color:#a6e22e>Backslash\EventStore\Query\QueryInterface</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> <span style=color:#a6e22e>Backslash\EventStore\Query\Metadata</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>TenantScopingRepositoryMiddleware</span> <span style=color:#66d9ef>implements</span> <span style=color:#a6e22e>MiddlewareInterface</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>__construct</span>(
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>string</span> $tenantId,
</span></span><span style=display:flex><span>    ) {
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>loadModel</span>(
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>string</span> $modelClass,
</span></span><span style=display:flex><span>        <span style=color:#f92672>?</span><span style=color:#a6e22e>QueryInterface</span> $query,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>RepositoryInterface</span> $next
</span></span><span style=display:flex><span>    )<span style=color:#f92672>:</span> <span style=color:#a6e22e>ModelInterface</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Add tenant filtering to query
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        $scopedQuery <span style=color:#f92672>=</span> $query<span style=color:#f92672>?-&gt;</span><span style=color:#a6e22e>and</span>(<span style=color:#a6e22e>Metadata</span><span style=color:#f92672>::</span><span style=color:#a6e22e>is</span>(<span style=color:#e6db74>&#39;tenant_id&#39;</span>, $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>tenantId</span>));
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> $next<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>loadModel</span>($modelClass, $scopedQuery);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>storeChanges</span>(<span style=color:#a6e22e>ModelInterface</span> $model, <span style=color:#a6e22e>RepositoryInterface</span> $next)<span style=color:#f92672>:</span> <span style=color:#a6e22e>void</span>
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        $next<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>storeChanges</span>($model);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}</span></span></code></pre></td></tr></table></div></div><h2 id=built-in-middleware>Built-in middleware<a class=anchor href=#built-in-middleware>#</a></h2><p>Backslash provides several ready-to-use middleware:</p><p><strong>CacheProjectionStoreMiddleware</strong> - Caches loaded projections in memory to avoid unnecessary storage communication,
significantly improving performance when projections are accessed multiple times:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#66d9ef>use</span> <span style=color:#a6e22e>Backslash\CacheProjectionStoreMiddleware\CacheProjectionStoreMiddleware</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$projectionStore<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>addMiddleware</span>(<span style=color:#66d9ef>new</span> <span style=color:#a6e22e>CacheProjectionStoreMiddleware</span>());</span></span></code></pre></td></tr></table></div></div><p><strong>PdoTransactionCommandDispatcherMiddleware</strong> - Creates a PDO transaction for command dispatch; rolls back if an
exception occurs to prevent new events from being written to the database:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#66d9ef>use</span> <span style=color:#a6e22e>Backslash\PdoTransactionCommandDispatcherMiddleware\PdoTransactionCommandDispatcherMiddleware</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$dispatcher<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>addMiddleware</span>(<span style=color:#66d9ef>new</span> <span style=color:#a6e22e>PdoTransactionCommandDispatcherMiddleware</span>($pdo));</span></span></code></pre></td></tr></table></div></div><p><strong>ProjectionStoreTransactionCommandDispatcherMiddleware</strong> - Calls <code>commit()</code> on ProjectionStore after command processing
completes successfully:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#66d9ef>use</span> <span style=color:#a6e22e>Backslash\ProjectionStoreTransactionCommandDispatcherMiddleware\ProjectionStoreTransactionCommandDispatcherMiddleware</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$dispatcher<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>addMiddleware</span>(
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>ProjectionStoreTransactionCommandDispatcherMiddleware</span>($projectionStore)
</span></span><span style=display:flex><span>);</span></span></code></pre></td></tr></table></div></div><p><strong>StreamEnricherEventBusMiddleware</strong> - Enriches events before publishing to EventBus:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#66d9ef>use</span> <span style=color:#a6e22e>Backslash\StreamEnricher\StreamEnricherEventBusMiddleware</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$eventBus<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>addMiddleware</span>(<span style=color:#66d9ef>new</span> <span style=color:#a6e22e>StreamEnricherEventBusMiddleware</span>($enricher));</span></span></code></pre></td></tr></table></div></div><p><strong>StreamEnricherEventStoreMiddleware</strong> - Enriches events before persisting to EventStore:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#66d9ef>use</span> <span style=color:#a6e22e>Backslash\StreamEnricher\StreamEnricherEventStoreMiddleware</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$eventStore<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>addMiddleware</span>(<span style=color:#66d9ef>new</span> <span style=color:#a6e22e>StreamEnricherEventStoreMiddleware</span>($enricher));</span></span></code></pre></td></tr></table></div></div><h2 id=middleware-execution-order>Middleware execution order<a class=anchor href=#middleware-execution-order>#</a></h2><p>Middleware executes in reverse order of registration (LIFO - Last In, First Out). The last middleware added executes
first:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span>$dispatcher<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>addMiddleware</span>($logging);      <span style=color:#75715e>// Executes third (innermost)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>$dispatcher<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>addMiddleware</span>($validation);   <span style=color:#75715e>// Executes second
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>$dispatcher<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>addMiddleware</span>($transaction);  <span style=color:#75715e>// Executes first (outermost)
</span></span></span></code></pre></td></tr></table></div></div><p>When a command is dispatched:</p><ol><li>Transaction middleware starts transaction</li><li>Validation middleware validates command</li><li>Logging middleware logs the command</li><li>Command handler executes</li><li>Logging middleware logs completion</li><li>Validation middleware completes</li><li>Transaction middleware commits</li></ol><p>This onion-layer pattern ensures middleware executes symmetrically before and after the core operation.</p><p>Here&rsquo;s a concrete example using Backslash&rsquo;s built-in middleware:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#66d9ef>use</span> <span style=color:#a6e22e>Backslash\ProjectionStoreTransactionCommandDispatcherMiddleware\ProjectionStoreTransactionCommandDispatcherMiddleware</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> <span style=color:#a6e22e>Backslash\PdoTransactionCommandDispatcherMiddleware\PdoTransactionCommandDispatcherMiddleware</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Order matters: PDO transaction wraps everything
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>$dispatcher<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>addMiddleware</span>(<span style=color:#66d9ef>new</span> <span style=color:#a6e22e>LoggingMiddleware</span>($logger));                                            <span style=color:#75715e>// Innermost
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>$dispatcher<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>addMiddleware</span>(<span style=color:#66d9ef>new</span> <span style=color:#a6e22e>ProjectionStoreTransactionCommandDispatcherMiddleware</span>($projectionStore)); <span style=color:#75715e>// Middle
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>$dispatcher<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>addMiddleware</span>(<span style=color:#66d9ef>new</span> <span style=color:#a6e22e>PdoTransactionCommandDispatcherMiddleware</span>($pdo));                       <span style=color:#75715e>// Outermost
</span></span></span></code></pre></td></tr></table></div></div><p>Execution flow:</p><ol><li>PDO transaction begins</li><li>ProjectionStore prepares for changes</li><li>Logging records command</li><li>Command executes, events are persisted</li><li>Logging records completion</li><li>ProjectionStore commits buffered projections</li><li>PDO transaction commits</li></ol><h2 id=best-practices>Best practices<a class=anchor href=#best-practices>#</a></h2><p><strong>Keep middleware focused.</strong> Each middleware should handle a single concern; avoid creating god middleware that handles
multiple responsibilities.</p><p><strong>Make middleware reusable.</strong> Write middleware that works with any component of its type, not just specific use cases.</p><p><strong>Consider execution order.</strong> Add middleware in the correct order based on dependencies; transactions should wrap
validation, validation should wrap logging, etc.</p><p><strong>Handle exceptions appropriately.</strong> Middleware can catch and transform exceptions, but be careful not to swallow
important errors that should propagate to callers.</p><p><strong>Test middleware independently.</strong> Middleware should be testable in isolation from the components they wrap.</p><p><strong>Document side effects.</strong> If middleware modifies state or has side effects, document this clearly in comments or
documentation.</p><p><strong>Use built-in middleware when available.</strong> Backslash provides common middleware implementations; use them instead of
rolling your own.</p><hr></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div></div><div></div></div><div class="flex flex-wrap justify-between"><span><a href=/testing/writing-test-scenarios/ class="flex align-center"><img src=/icons/backward.svg class=book-icon alt=Previous title="Writing Test Scenarios">
<span>Writing Test Scenarios</span>
</a></span><span><a href=/customization/enriching-event-streams/ class="flex align-center"><span>Enriching Event Streams</span>
<img src=/icons/forward.svg class=book-icon alt=Next title="Enriching Event Streams"></a></span></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#understanding-middleware>Understanding middleware</a></li><li><a href=#commanddispatcher-middleware>CommandDispatcher middleware</a></li><li><a href=#eventstore-middleware>EventStore middleware</a></li><li><a href=#eventbus-middleware>EventBus middleware</a></li><li><a href=#projectionstore-middleware>ProjectionStore middleware</a></li><li><a href=#repository-middleware>Repository middleware</a></li><li><a href=#built-in-middleware>Built-in middleware</a></li><li><a href=#middleware-execution-order>Middleware execution order</a></li><li><a href=#best-practices>Best practices</a></li></ul></nav></div></aside></main></body></html>