<!doctype html><html lang=en-ca dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Enriching Event Streams#
Event stream enrichment allows applications to inject metadata into events as they flow through the system. This
metadata provides contextual information like the current tenant, authenticated user, or correlation keys.
Enrichment occurs after the model records events but before they are persisted to EventStore or published to EventBus.
Understanding stream enrichment#
An application should have a single implementation of StreamEnricherInterface:


1
2
3
4


interface StreamEnricherInterface
{
    public function enrich(RecordedEventStream $stream): RecordedEventStream;
}

Using a single enricher avoids metadata conflicts, ensures predictable execution order, and simplifies configuration.
The enricher&rsquo;s role is to inject metadata into events. This implementation can receive services as dependencies when
contextual information is needed. Common metadata includes:"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://backslashphp.github.io/backslash/customization/enriching-event-streams/"><meta property="og:site_name" content="Backslash PHP Developer Guide"><meta property="og:title" content="Enriching Event Streams"><meta property="og:description" content="Enriching Event Streams# Event stream enrichment allows applications to inject metadata into events as they flow through the system. This metadata provides contextual information like the current tenant, authenticated user, or correlation keys.
Enrichment occurs after the model records events but before they are persisted to EventStore or published to EventBus.
Understanding stream enrichment# An application should have a single implementation of StreamEnricherInterface:
1 2 3 4 interface StreamEnricherInterface { public function enrich(RecordedEventStream $stream): RecordedEventStream; } Using a single enricher avoids metadata conflicts, ensures predictable execution order, and simplifies configuration. The enricherâ€™s role is to inject metadata into events. This implementation can receive services as dependencies when contextual information is needed. Common metadata includes:"><meta property="og:locale" content="en_ca"><meta property="og:type" content="article"><meta property="article:section" content="customization"><meta property="article:modified_time" content="2025-11-11T17:09:05-05:00"><title>Enriching Event Streams | Backslash PHP Developer Guide</title><link rel=icon href=/backslash/favicon.png><link rel=manifest href=/backslash/manifest.json><link rel=canonical href=https://backslashphp.github.io/backslash/customization/enriching-event-streams/><link rel=stylesheet href=/backslash/book.min.c0e41de750417a94c4724981669dbe7955cfa422e1b2a84d4d2ac5e7d4a300f2.css integrity="sha256-wOQd51BBepTEckmBZp2+eVXPpCLhsqhNTSrF59SjAPI=" crossorigin=anonymous><script defer src=/backslash/fuse.min.js></script><script defer src=/backslash/en.search.min.bf5cf25dfd21948ac026e92ebfbb526af7dc35e848feb1e5549f4f2ff0904a2c.js integrity="sha256-v1zyXf0hlIrAJukuv7tSavfcNehI/rHlVJ9PL/CQSiw=" crossorigin=anonymous></script></head><body dir=ltr class="book-kind-page book-type-customization"><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/backslash/><span>Backslash PHP Developer Guide</span></a></h2><div class="book-search hidden"><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script><ul><li><a href=https://github.com/backslashphp/backslash target=_blank rel=noopener>Source code</a></li><li><a href=https://github.com/backslashphp/demo target=_blank rel=noopener>Demo application</a></li></ul><ul><li class=book-section-flat><a>Getting Started</a><ul><li><a href=/backslash/getting-started/introduction/>Introduction</a></li><li><a href=/backslash/getting-started/architecture-overview/>Architecture Overview</a></li><li><a href=/backslash/getting-started/quick-start-guide/>Quick Start Guide</a></li></ul></li><li class=book-section-flat><a>Event Sourcing</a><ul><li><a href=/backslash/event-sourcing/understanding-event-sourcing/>Understanding Event Sourcing</a></li><li><a href=/backslash/event-sourcing/defining-events/>Defining Events</a></li><li><a href=/backslash/event-sourcing/querying-events/>Querying Events</a></li><li><a href=/backslash/event-sourcing/building-models/>Building Models</a></li></ul></li><li class=book-section-flat><a>Commands and Projections (CQRS)</a><ul><li><a href=/backslash/cqrs/understanding-cqrs/>Understanding CQRS</a></li><li><a href=/backslash/cqrs/dispatching-commands/>Dispatching Commands</a></li><li><a href=/backslash/cqrs/reacting-with-event-handlers/>Reacting with Event Handlers</a></li><li><a href=/backslash/cqrs/building-projections/>Building Projections</a></li></ul></li><li class=book-section-flat><a>Testing Your Application</a><ul><li><a href=/backslash/testing/setting-up-tests/>Setting Up Tests</a></li><li><a href=/backslash/testing/writing-test-scenarios/>Writing Test Scenarios</a></li></ul></li><li class=book-section-flat><a>Customization</a><ul><li><a href=/backslash/customization/extending-with-middleware/>Extending with Middleware</a></li><li><a href=/backslash/customization/enriching-event-streams/ class=active>Enriching Event Streams</a></li></ul></li><li class=book-section-flat><a>Application Setup</a><ul><li><a href=/backslash/application-setup/defining-services/>Defining Services</a></li><li><a href=/backslash/application-setup/registering-handlers/>Registering Handlers</a></li><li><a href=/backslash/application-setup/using-the-bootstrap-file/>Using the Bootstrap File</a></li></ul></li><li class=book-section-flat><a>Maintenance</a><ul><li><a href=/backslash/maintenance/rebuilding-projections/>Rebuilding Projections</a></li></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class="book-header hidden"><div class="flex align-center justify-between"><label for=menu-control><img src=/backslash/icons/menu.svg class=book-icon alt=Menu></label><h3>Enriching Event Streams</h3><label for=toc-control><img src=/backslash/icons/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class=hidden><nav id=TableOfContents><ul><li><a href=#understanding-stream-enrichment>Understanding stream enrichment</a></li><li><a href=#creating-a-stream-enricher>Creating a stream enricher</a></li><li><a href=#registering-the-enricher>Registering the enricher</a></li><li><a href=#using-enriched-metadata>Using enriched metadata</a></li><li><a href=#best-practices>Best practices</a></li></ul></nav></aside></header><article class="markdown book-article"><h1 id=enriching-event-streams>Enriching Event Streams<a class=anchor href=#enriching-event-streams>#</a></h1><p>Event stream enrichment allows applications to inject metadata into events as they flow through the system. This
metadata provides contextual information like the current tenant, authenticated user, or correlation keys.</p><p>Enrichment occurs after the model records events but before they are persisted to EventStore or published to EventBus.</p><h2 id=understanding-stream-enrichment>Understanding stream enrichment<a class=anchor href=#understanding-stream-enrichment>#</a></h2><p>An application should have a single implementation of <code>StreamEnricherInterface</code>:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>StreamEnricherInterface</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>enrich</span>(<span style=color:#a6e22e>RecordedEventStream</span> $stream)<span style=color:#f92672>:</span> <span style=color:#a6e22e>RecordedEventStream</span>;
</span></span><span style=display:flex><span>}</span></span></code></pre></td></tr></table></div></div><p>Using a single enricher avoids metadata conflicts, ensures predictable execution order, and simplifies configuration.
The enricher&rsquo;s role is to inject metadata into events. This implementation can receive services as dependencies when
contextual information is needed. Common metadata includes:</p><ul><li>Current tenant in multi-tenant applications</li><li>Authenticated user information</li><li>Correlation IDs for request tracing</li><li>Execution context (batch job, API request, CLI command)</li></ul><h2 id=creating-a-stream-enricher>Creating a stream enricher<a class=anchor href=#creating-a-stream-enricher>#</a></h2><p>Here&rsquo;s an example enricher that adds tenant and user information:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#66d9ef>use</span> <span style=color:#a6e22e>Backslash\StreamEnricher\StreamEnricherInterface</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> <span style=color:#a6e22e>Backslash\Event\RecordedEventStream</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> <span style=color:#a6e22e>Backslash\Event\RecordedEvent</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>StreamEnricher</span> <span style=color:#66d9ef>implements</span> <span style=color:#a6e22e>StreamEnricherInterface</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>__construct</span>(
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>TenantService</span> $tenantService,
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>AuthService</span> $authService,
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>CorrelationIdService</span> $correlationService,
</span></span><span style=display:flex><span>    ) {
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>enrich</span>(<span style=color:#a6e22e>RecordedEventStream</span> $stream)<span style=color:#f92672>:</span> <span style=color:#a6e22e>RecordedEventStream</span>
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        $enrichedStream <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>RecordedEventStream</span>();
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>foreach</span> ($stream<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>getRecordedEvents</span>() <span style=color:#66d9ef>as</span> $recordedEvent) {
</span></span><span style=display:flex><span>            $metadata <span style=color:#f92672>=</span> $recordedEvent<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>getMetadata</span>();
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#75715e>// Add tenant information
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>if</span> ($this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>tenantService</span><span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>hasTenant</span>()) {
</span></span><span style=display:flex><span>                $metadata <span style=color:#f92672>=</span> $metadata<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>with</span>(<span style=color:#e6db74>&#39;tenant_id&#39;</span>, $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>tenantService</span><span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>getCurrentTenantId</span>());
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#75715e>// Add authenticated user
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>if</span> ($this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>authService</span><span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>isAuthenticated</span>()) {
</span></span><span style=display:flex><span>                $metadata <span style=color:#f92672>=</span> $metadata<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>with</span>(<span style=color:#e6db74>&#39;user_id&#39;</span>, $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>authService</span><span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>getCurrentUserId</span>());
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#75715e>// Add correlation ID for tracing
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            $metadata <span style=color:#f92672>=</span> $metadata<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>with</span>(<span style=color:#e6db74>&#39;correlation_id&#39;</span>, $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>correlationService</span><span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>get</span>());
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            $enrichedStream <span style=color:#f92672>=</span> $enrichedStream<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>withRecordedEvents</span>(
</span></span><span style=display:flex><span>                $recordedEvent<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>withMetadata</span>($metadata)
</span></span><span style=display:flex><span>            );
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> $enrichedStream;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}</span></span></code></pre></td></tr></table></div></div><p>This enricher receives services as dependencies and uses them to inject relevant metadata into every event.</p><h2 id=registering-the-enricher>Registering the enricher<a class=anchor href=#registering-the-enricher>#</a></h2><p>Backslash provides two middleware for stream enrichment, as introduced in section 14:</p><ul><li><strong>StreamEnricherEventStoreMiddleware</strong>: Enriches events before persisting to EventStore</li><li><strong>StreamEnricherEventBusMiddleware</strong>: Enriches events before publishing to EventBus</li></ul><p>Register both middleware during application bootstrap to ensure consistent metadata in storage and when published:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#66d9ef>use</span> <span style=color:#a6e22e>Backslash\StreamEnricher\StreamEnricherEventStoreMiddleware</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> <span style=color:#a6e22e>Backslash\StreamEnricher\StreamEnricherEventBusMiddleware</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$enricher <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>StreamEnricher</span>($tenantService, $authService, $correlationService);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Enrich before persisting
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>$eventStore<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>addMiddleware</span>(<span style=color:#66d9ef>new</span> <span style=color:#a6e22e>StreamEnricherEventStoreMiddleware</span>($enricher));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Enrich before publishing
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>$eventBus<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>addMiddleware</span>(<span style=color:#66d9ef>new</span> <span style=color:#a6e22e>StreamEnricherEventBusMiddleware</span>($enricher));</span></span></code></pre></td></tr></table></div></div><h2 id=using-enriched-metadata>Using enriched metadata<a class=anchor href=#using-enriched-metadata>#</a></h2><p>Enriched metadata becomes available throughout the application. Event handlers can access this metadata to make
decisions or add context:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>NotificationHandler</span> <span style=color:#66d9ef>implements</span> <span style=color:#a6e22e>EventHandlerInterface</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>use</span> <span style=color:#a6e22e>EventHandlerTrait</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>handleStudentSubscribedToCourseEvent</span>(
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>StudentSubscribedToCourseEvent</span> $event,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>RecordedEvent</span> $recordedEvent,
</span></span><span style=display:flex><span>    )<span style=color:#f92672>:</span> <span style=color:#a6e22e>void</span> {
</span></span><span style=display:flex><span>        $metadata <span style=color:#f92672>=</span> $recordedEvent<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>getMetadata</span>();
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Access enriched tenant information
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        $tenantId <span style=color:#f92672>=</span> $metadata<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#39;tenant_id&#39;</span>);
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Access correlation ID for tracing
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        $correlationId <span style=color:#f92672>=</span> $metadata<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#39;correlation_id&#39;</span>);
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>logger</span><span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>info</span>(<span style=color:#e6db74>&#39;Student subscribed&#39;</span>, [
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;tenant_id&#39;</span> <span style=color:#f92672>=&gt;</span> $tenantId,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;correlation_id&#39;</span> <span style=color:#f92672>=&gt;</span> $correlationId,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;student_id&#39;</span> <span style=color:#f92672>=&gt;</span> $event<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>studentId</span>,
</span></span><span style=display:flex><span>        ]);
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Send notification with tenant context
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>notifier</span><span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>send</span>($event<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>studentId</span>, $tenantId);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}</span></span></code></pre></td></tr></table></div></div><p>Queries can also filter events based on enriched metadata:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#66d9ef>use</span> <span style=color:#a6e22e>Backslash\EventStore\Query\Metadata</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Load only events for specific tenant
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>$query <span style=color:#f92672>=</span> <span style=color:#a6e22e>EventClass</span><span style=color:#f92672>::</span><span style=color:#a6e22e>is</span>(<span style=color:#a6e22e>CourseDefinedEvent</span><span style=color:#f92672>::</span><span style=color:#a6e22e>class</span>)
</span></span><span style=display:flex><span>    <span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>and</span>(<span style=color:#a6e22e>Metadata</span><span style=color:#f92672>::</span><span style=color:#a6e22e>is</span>(<span style=color:#e6db74>&#39;tenant_id&#39;</span>, $currentTenantId));</span></span></code></pre></td></tr></table></div></div><h2 id=best-practices>Best practices<a class=anchor href=#best-practices>#</a></h2><p><strong>Use one enricher per application.</strong> Create a single <code>StreamEnricherInterface</code> implementation that handles all metadata
injection; avoid multiple enrichers with overlapping concerns.</p><p><strong>Inject services as dependencies when needed.</strong> If the enricher requires contextual information, pass services like
authentication, tenant management, or correlation tracking as constructor dependencies rather than accessing global
state.</p><p><strong>Register both middleware.</strong> Always register <code>StreamEnricherEventStoreMiddleware</code> and
<code>StreamEnricherEventBusMiddleware</code> to ensure metadata consistency between persisted events and published events.</p><p><strong>Enrich metadata, not payloads.</strong> Event payloads should contain domain information; metadata is for technical concerns
like tenant context, user information, or correlation IDs.</p><p><strong>Avoid sensitive data.</strong> Metadata is stored and potentially logged; avoid adding passwords, tokens, or other sensitive
information unless absolutely required.</p><p><strong>Keep enrichment fast.</strong> Enrichment runs for every event; avoid expensive operations like database queries or external
API calls.</p><hr></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div></div><div></div></div><div class="flex flex-wrap justify-between"><span><a href=/backslash/customization/extending-with-middleware/ class="flex align-center"><img src=/backslash/icons/backward.svg class=book-icon alt=Previous title="Extending with Middleware">
<span>Extending with Middleware</span>
</a></span><span><a href=/backslash/application-setup/defining-services/ class="flex align-center"><span>Defining Services</span>
<img src=/backslash/icons/forward.svg class=book-icon alt=Next title="Defining Services"></a></span></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#understanding-stream-enrichment>Understanding stream enrichment</a></li><li><a href=#creating-a-stream-enricher>Creating a stream enricher</a></li><li><a href=#registering-the-enricher>Registering the enricher</a></li><li><a href=#using-enriched-metadata>Using enriched metadata</a></li><li><a href=#best-practices>Best practices</a></li></ul></nav></div></aside></main></body></html>